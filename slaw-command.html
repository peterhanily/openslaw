<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slaw Command â€” OpenSlaw.ai</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .game-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .game-header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .game-header h1 span {
            color: #4ade80;
        }

        .game-header p {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .game-container {
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(22, 163, 74, 0.15), 0 0 0 1px rgba(255,255,255,0.05);
        }

        canvas {
            display: block;
            touch-action: manipulation;
            max-width: 100%;
            height: auto;
        }

        .game-footer {
            text-align: center;
            margin-top: 1rem;
        }

        .game-footer a {
            color: #4ade80;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .game-footer a:hover { text-decoration: underline; }

        .controls-hint {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1>ğŸ¦ Slaw <span>Command</span></h1>
        <p>Cybernetic AI lobsters defend against falling coleslaw.</p>
    </div>
    <div class="game-container">
        <canvas id="game" width="600" height="400"></canvas>
    </div>
    <div class="game-footer">
        <a href="/">&larr; Back to OpenSlaw.ai</a>
        <div class="controls-hint">Click/tap to fire &bull; Space to start/restart</div>
    </div>

    <script>
    (function() {
        'use strict';

        var canvas = document.getElementById('game');
        var ctx = canvas.getContext('2d');
        var W = canvas.width;
        var H = canvas.height;

        // â”€â”€ State machine â”€â”€
        var STATE_MENU = 0, STATE_WAVE_INTRO = 1, STATE_PLAYING = 2,
            STATE_WAVE_BONUS = 3, STATE_DEAD = 4;
        var state = STATE_MENU;

        // â”€â”€ Scores & tracking â”€â”€
        var score = 0;
        var highScore = parseInt(localStorage.getItem('slaw-command-high') || '0', 10);
        var wave = 1;
        var frame = 0;
        var deathFrame = 0;
        var waveIntroFrame = 0;
        var waveBonusFrame = 0;
        var bonusCityPts = 0;
        var bonusAmmoPts = 0;
        var bonusTotalPts = 0;

        // â”€â”€ Toasts â”€â”€
        var toasts = [];

        // â”€â”€ Screen flash â”€â”€
        var screenFlash = 0;

        // â”€â”€ Stars background â”€â”€
        var stars = [];
        for (var i = 0; i < 100; i++) {
            stars.push({
                x: Math.random() * W,
                y: Math.random() * H,
                size: 0.5 + Math.random() * 1.5,
                opacity: 0.15 + Math.random() * 0.45
            });
        }

        // â”€â”€ Ground â”€â”€
        var GROUND_Y = H - 40;

        // Generate jagged ground line
        var groundPoints = [];
        (function() {
            for (var gx = 0; gx <= W; gx += 8) {
                groundPoints.push({
                    x: gx,
                    y: GROUND_Y + (Math.random() - 0.5) * 4
                });
            }
        })();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   CITY & BATTERY NAMES + POSITIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        var CITY_NAMES = [
            'CLAW-01', 'PINCER-7', 'SHELL-X',
            'CHITIN-3', 'ANTENNA-9', 'CARAPACE-K'
        ];
        var CITY_COUNT = 6;

        var BATTERY_NAMES = ['Port Claw', 'Neural Array', 'Starboard Claw'];
        var BATTERY_SPEEDS = [4, 6, 4]; // center is faster
        var AMMO_PER_BATTERY = 10;

        // Layout: Bat0 - City0 City1 City2 - Bat1 - City3 City4 City5 - Bat2
        var BATTERY_X = [W * 0.10, W * 0.50, W * 0.90];
        var CITY_X = [W * 0.22, W * 0.33, W * 0.42, W * 0.58, W * 0.67, W * 0.78];

        var batteries = [];
        var cities = [];

        function initBatteries() {
            batteries = [];
            for (var i = 0; i < 3; i++) {
                batteries.push({
                    x: BATTERY_X[i],
                    y: GROUND_Y - 2,
                    ammo: AMMO_PER_BATTERY,
                    alive: true,
                    name: BATTERY_NAMES[i],
                    speed: BATTERY_SPEEDS[i]
                });
            }
        }

        function initCities() {
            cities = [];
            for (var i = 0; i < CITY_COUNT; i++) {
                cities.push({
                    x: CITY_X[i],
                    y: GROUND_Y + 5,
                    alive: true,
                    name: CITY_NAMES[i]
                });
            }
        }

        // â”€â”€ Player counter-missiles â”€â”€
        var counterMissiles = [];

        // â”€â”€ Explosions â”€â”€
        var explosions = [];
        var EXPLOSION_MAX_RADIUS = 38;
        var EXPLOSION_GROW_SPEED = 1.8;
        var EXPLOSION_HOLD = 10;
        var EXPLOSION_SHRINK_SPEED = 1.5;

        // â”€â”€ Enemy missiles â”€â”€
        var enemyMissiles = [];

        // â”€â”€ Bombers â”€â”€
        var bombers = [];

        // â”€â”€ Particles â”€â”€
        var particles = [];

        // â”€â”€ Wave config â”€â”€
        var waveMissileCount = 0;
        var waveMissilesSpawned = 0;
        var waveSpawnTimer = 0;
        var waveSpawnInterval = 60;
        var waveBomberCount = 0;
        var waveBombersSpawned = 0;
        var waveBomberTimer = 0;

        // â”€â”€ Crosshair â”€â”€
        var mouseX = W / 2;
        var mouseY = H / 2;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   WAVE INTRO DATA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        var WAVE_INTROS = [
            { title: 'COLESLAW INBOUND', sub: 'The first bowls are falling. Lobsters, engage claws.' },
            { title: 'DOUBLE DOLLOP', sub: "They're dropping more slaw from above." },
            { title: 'THE RAISINS APPROACH', sub: 'Who puts raisins in a weapon of war?' },
            { title: 'SUPPLY CHAIN ATTACK', sub: "They've weaponized the vinegar." },
            { title: 'PINEAPPLE OFFENSIVE', sub: 'Tropical coleslaw variant detected. Lobsters hold firm.' },
            { title: 'RANCH INCURSION', sub: "They're trying to rebrand our lobsters as seafood salad." }
        ];

        var WAVE7_TITLES = ['MIRACLE WHIP PROTOCOL', 'CONDIMENT CONVERGENCE', 'FINAL DOLLOP'];
        var WAVE7_SUBS = [
            'The forbidden sauce approaches.',
            'All coleslaw united against lobster-kind.',
            'Cyber-claws at maximum power.',
            'They brought the squeeze bottles.',
            'Carapace integrity holding... barely.',
            "We didn't start the slaw fire."
        ];

        function getWaveIntro(w) {
            if (w <= WAVE_INTROS.length) {
                return WAVE_INTROS[w - 1];
            }
            return {
                title: WAVE7_TITLES[(w - 7) % WAVE7_TITLES.length],
                sub: WAVE7_SUBS[Math.floor(Math.random() * WAVE7_SUBS.length)]
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   HELPERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function roundRect(x, y, w, h, r) {
            if (ctx.roundRect) {
                ctx.beginPath();
                ctx.roundRect(x, y, w, h, r);
            } else {
                ctx.beginPath();
                ctx.moveTo(x + r, y);
                ctx.lineTo(x + w - r, y);
                ctx.quadraticCurveTo(x + w, y, x + w, y + r);
                ctx.lineTo(x + w, y + h - r);
                ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                ctx.lineTo(x + r, y + h);
                ctx.quadraticCurveTo(x, y + h, x, y + h - r);
                ctx.lineTo(x, y + r);
                ctx.quadraticCurveTo(x, y, x + r, y);
                ctx.closePath();
            }
        }

        function getMultiplier() {
            return Math.floor((wave - 1) / 2) + 1;
        }

        function dist(x1, y1, x2, y2) {
            var dx = x1 - x2, dy = y1 - y2;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   TOAST SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function addToast(msg, x, y, color) {
            toasts.push({ msg: msg, x: x, y: y, life: 45, color: color || '#4ade80' });
        }

        function updateToasts() {
            for (var i = toasts.length - 1; i >= 0; i--) {
                toasts[i].life--;
                toasts[i].y -= 0.6;
                if (toasts[i].life <= 0) toasts.splice(i, 1);
            }
        }

        function drawToasts() {
            for (var i = 0; i < toasts.length; i++) {
                var t = toasts[i];
                var alpha = t.life < 15 ? t.life / 15 : 1;
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.font = '700 13px Inter, sans-serif';
                ctx.fillStyle = t.color;
                ctx.textAlign = 'center';
                ctx.fillText(t.msg, t.x, t.y);
                ctx.restore();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   PARTICLES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function spawnParticles(x, y, count, color) {
            for (var i = 0; i < count; i++) {
                var angle = Math.random() * Math.PI * 2;
                var speed = 0.5 + Math.random() * 2;
                particles.push({
                    x: x, y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 20 + Math.floor(Math.random() * 20),
                    color: color || '#4ade80',
                    size: 1 + Math.random() * 2
                });
            }
        }

        function updateParticles() {
            for (var i = particles.length - 1; i >= 0; i--) {
                var p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        function drawParticles() {
            for (var i = 0; i < particles.length; i++) {
                var p = particles[i];
                var alpha = p.life < 10 ? p.life / 10 : 1;
                ctx.save();
                ctx.globalAlpha = alpha * 0.8;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   DRAWING: Background
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function drawBackground() {
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, W, H);

            // Stars
            for (var i = 0; i < stars.length; i++) {
                var s = stars[i];
                var twinkle = 0.5 + 0.5 * Math.sin(frame * 0.02 + i);
                ctx.save();
                ctx.globalAlpha = s.opacity * twinkle;
                ctx.fillStyle = '#e2e8f0';
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }

            // Scanlines (subtle CRT feel)
            ctx.save();
            ctx.globalAlpha = 0.03;
            ctx.fillStyle = '#000';
            for (var sy = 0; sy < H; sy += 3) {
                ctx.fillRect(0, sy, W, 1);
            }
            ctx.restore();

            // Jagged ground
            ctx.fillStyle = '#1e293b';
            ctx.beginPath();
            ctx.moveTo(0, H);
            for (var g = 0; g < groundPoints.length; g++) {
                ctx.lineTo(groundPoints[g].x, groundPoints[g].y);
            }
            ctx.lineTo(W, H);
            ctx.closePath();
            ctx.fill();

            // Ground edge line
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (var g2 = 0; g2 < groundPoints.length; g2++) {
                if (g2 === 0) ctx.moveTo(groundPoints[g2].x, groundPoints[g2].y);
                else ctx.lineTo(groundPoints[g2].x, groundPoints[g2].y);
            }
            ctx.stroke();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   DRAWING: Cities
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function drawCities() {
            for (var i = 0; i < cities.length; i++) {
                var c = cities[i];
                var cx = c.x;
                var cy = c.y;

                if (c.alive) {
                    // Cybernetic AI Lobster
                    var bob = Math.sin(frame * 0.04 + i * 1.5) * 1.5;
                    var ly = cy - 2 + bob;

                    // Body (red-orange)
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.ellipse(cx, ly, 10, 6, 0, 0, Math.PI * 2);
                    ctx.fill();

                    // Tail segments
                    ctx.fillStyle = '#dc2626';
                    ctx.beginPath();
                    ctx.ellipse(cx, ly + 7, 6, 3, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.ellipse(cx, ly + 10, 4, 2, 0, 0, Math.PI);
                    ctx.fill();

                    // Claws
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.ellipse(cx - 14, ly - 3, 5, 3, -0.4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.ellipse(cx + 14, ly - 3, 5, 3, 0.4, 0, Math.PI * 2);
                    ctx.fill();
                    // Claw pincers
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.arc(cx - 18, ly - 4, 3, -0.5, 1.5);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(cx + 18, ly - 4, 3, 1.6, 3.6);
                    ctx.stroke();

                    // Cybernetic eyes (glowing green)
                    ctx.fillStyle = '#4ade80';
                    ctx.shadowColor = '#4ade80';
                    ctx.shadowBlur = 4;
                    ctx.beginPath();
                    ctx.arc(cx - 4, ly - 5, 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(cx + 4, ly - 5, 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;

                    // Circuit lines on body
                    ctx.strokeStyle = '#4ade80';
                    ctx.lineWidth = 0.7;
                    ctx.globalAlpha = 0.4 + 0.2 * Math.sin(frame * 0.08 + i);
                    ctx.beginPath();
                    ctx.moveTo(cx - 7, ly); ctx.lineTo(cx + 7, ly);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(cx, ly - 4); ctx.lineTo(cx, ly + 4);
                    ctx.stroke();
                    ctx.globalAlpha = 1;

                    // Antennae
                    ctx.strokeStyle = '#94a3b8';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(cx - 3, ly - 6);
                    ctx.lineTo(cx - 6, ly - 12);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(cx + 3, ly - 6);
                    ctx.lineTo(cx + 6, ly - 12);
                    ctx.stroke();
                    // Antenna tips glow
                    ctx.fillStyle = '#4ade80';
                    ctx.beginPath();
                    ctx.arc(cx - 6, ly - 12, 1, 0, Math.PI * 2);
                    ctx.arc(cx + 6, ly - 12, 1, 0, Math.PI * 2);
                    ctx.fill();

                    // Callsign label
                    ctx.font = '600 7px Inter, sans-serif';
                    ctx.fillStyle = '#94a3b8';
                    ctx.textAlign = 'center';
                    ctx.fillText(c.name, cx, cy + 18);
                } else {
                    // Destroyed lobster â€” sparking wreckage
                    ctx.fillStyle = '#1e293b';
                    ctx.beginPath();
                    ctx.ellipse(cx, cy, 10, 5, 0.2, 0, Math.PI * 2);
                    ctx.fill();

                    // Broken claw fragments
                    ctx.fillStyle = '#7f1d1d';
                    ctx.beginPath();
                    ctx.ellipse(cx - 8, cy + 2, 3, 2, 0.5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.ellipse(cx + 10, cy + 1, 3, 2, -0.3, 0, Math.PI * 2);
                    ctx.fill();

                    // Sparking circuit (intermittent)
                    if (Math.sin(frame * 0.15 + i * 2) > 0.3) {
                        ctx.fillStyle = '#4ade80';
                        ctx.globalAlpha = 0.3;
                        ctx.beginPath();
                        ctx.arc(cx + (i % 2 ? -3 : 3), cy - 3, 1.5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.globalAlpha = 1;
                    }

                    // Smoke wisps
                    var smokeAlpha = 0.15 + 0.1 * Math.sin(frame * 0.05 + i);
                    ctx.save();
                    ctx.globalAlpha = smokeAlpha;
                    ctx.fillStyle = '#64748b';
                    ctx.beginPath();
                    ctx.arc(cx - 3, cy - 8 - Math.sin(frame * 0.03 + i) * 2, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(cx + 4, cy - 10 - Math.sin(frame * 0.04 + i + 1) * 2, 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();

                    // Dimmed callsign
                    ctx.font = '600 7px Inter, sans-serif';
                    ctx.fillStyle = '#334155';
                    ctx.textAlign = 'center';
                    ctx.fillText(c.name, cx, cy + 18);
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   DRAWING: Batteries (3 bunkers)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function drawBatteries() {
            for (var i = 0; i < batteries.length; i++) {
                var b = batteries[i];
                var bx = b.x;
                var by = b.y;

                if (b.alive) {
                    // Bunker base
                    ctx.fillStyle = '#334155';
                    ctx.beginPath();
                    ctx.moveTo(bx - 16, by + 4);
                    ctx.lineTo(bx - 20, by + 4);
                    ctx.lineTo(bx - 14, by - 6);
                    ctx.lineTo(bx + 14, by - 6);
                    ctx.lineTo(bx + 20, by + 4);
                    ctx.lineTo(bx + 16, by + 4);
                    ctx.closePath();
                    ctx.fill();

                    // Turret triangle
                    ctx.fillStyle = i === 1 ? '#facc15' : '#4ade80';
                    ctx.beginPath();
                    ctx.moveTo(bx, by - 16);
                    ctx.lineTo(bx - 8, by - 6);
                    ctx.lineTo(bx + 8, by - 6);
                    ctx.closePath();
                    ctx.fill();

                    // Turret glow
                    ctx.save();
                    ctx.globalAlpha = 0.3 + 0.1 * Math.sin(frame * 0.08 + i);
                    ctx.fillStyle = i === 1 ? '#facc15' : '#4ade80';
                    ctx.beginPath();
                    ctx.arc(bx, by - 10, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();

                    // Ammo count below
                    ctx.font = '700 9px Inter, sans-serif';
                    ctx.fillStyle = b.ammo > 3 ? '#4ade80' : (b.ammo > 0 ? '#facc15' : '#ef4444');
                    ctx.textAlign = 'center';
                    ctx.fillText(b.ammo, bx, by + 16);
                } else {
                    // Destroyed battery â€” rubble
                    ctx.fillStyle = '#1e293b';
                    ctx.beginPath();
                    ctx.moveTo(bx - 18, by + 4);
                    ctx.lineTo(bx - 10, by - 2);
                    ctx.lineTo(bx + 10, by - 2);
                    ctx.lineTo(bx + 18, by + 4);
                    ctx.closePath();
                    ctx.fill();

                    ctx.strokeStyle = '#334155';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   ENEMY MISSILES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function getTargets() {
            // Returns all valid targets (alive cities + alive batteries)
            var targets = [];
            for (var i = 0; i < cities.length; i++) {
                if (cities[i].alive) targets.push({ type: 'city', idx: i, x: cities[i].x, y: cities[i].y });
            }
            for (var j = 0; j < batteries.length; j++) {
                if (batteries[j].alive) targets.push({ type: 'battery', idx: j, x: batteries[j].x, y: batteries[j].y });
            }
            return targets;
        }

        function spawnEnemyMissile(type) {
            var targets = getTargets();
            var cityTargets = [];
            for (var i = 0; i < targets.length; i++) {
                if (targets[i].type === 'city') cityTargets.push(targets[i]);
            }
            // Prefer city targets, but can also target batteries
            var pool = cityTargets.length > 0 ? cityTargets : targets;
            if (pool.length === 0) return;

            var target = pool[Math.floor(Math.random() * pool.length)];

            var startX = 30 + Math.random() * (W - 60);
            var startY = -5;

            var dx = target.x - startX;
            var dy = target.y - startY;
            var d = Math.sqrt(dx * dx + dy * dy);
            if (d < 1) d = 1;

            var baseSpeed = 0.5 + wave * 0.07;

            var missile = {
                x: startX, y: startY,
                startX: startX, startY: startY,
                targetX: target.x, targetY: target.y,
                targetType: target.type,
                targetIdx: target.idx,
                type: type,
                speed: baseSpeed,
                vx: (dx / d) * baseSpeed,
                vy: (dy / d) * baseSpeed,
                alive: true,
                splitDone: false
            };

            if (type === 'pineapple') {
                missile.speed = baseSpeed * 1.4;
                missile.vx = (dx / d) * missile.speed;
                missile.vy = (dy / d) * missile.speed;
            } else if (type === 'smart') {
                missile.speed = baseSpeed * 0.9;
                missile.vx = (dx / d) * missile.speed;
                missile.vy = (dy / d) * missile.speed;
            }

            enemyMissiles.push(missile);
        }

        function spawnChildMissile(parent) {
            var targets = getTargets();
            var cityTargets = [];
            for (var i = 0; i < targets.length; i++) {
                if (targets[i].type === 'city') cityTargets.push(targets[i]);
            }
            var pool = cityTargets.length > 0 ? cityTargets : targets;
            if (pool.length === 0) return null;

            var target = pool[Math.floor(Math.random() * pool.length)];

            var dx = target.x - parent.x;
            var dy = target.y - parent.y;
            var d = Math.sqrt(dx * dx + dy * dy);
            if (d < 1) d = 1;

            var speed = parent.speed * 0.9;

            return {
                x: parent.x, y: parent.y,
                startX: parent.x, startY: parent.y,
                targetX: target.x, targetY: target.y,
                targetType: target.type,
                targetIdx: target.idx,
                type: 'raisin_child',
                speed: speed,
                vx: (dx / d) * speed,
                vy: (dy / d) * speed,
                alive: true,
                splitDone: true
            };
        }

        function updateEnemyMissiles() {
            for (var i = enemyMissiles.length - 1; i >= 0; i--) {
                var m = enemyMissiles[i];
                if (!m.alive) {
                    enemyMissiles.splice(i, 1);
                    continue;
                }

                // Smart missiles: curve away from nearby explosions
                if (m.type === 'smart') {
                    for (var ei = 0; ei < explosions.length; ei++) {
                        var ex = explosions[ei];
                        var edist = dist(m.x, m.y, ex.x, ex.y);
                        if (edist < ex.radius + 60 && edist > 5) {
                            // Push away from explosion
                            var pushX = (m.x - ex.x) / edist * 0.3;
                            var pushY = (m.y - ex.y) / edist * 0.15;
                            m.vx += pushX;
                            m.vy += pushY;
                            // Re-normalize to maintain speed
                            var spd = Math.sqrt(m.vx * m.vx + m.vy * m.vy);
                            if (spd > 0) {
                                m.vx = (m.vx / spd) * m.speed;
                                m.vy = Math.abs((m.vy / spd) * m.speed); // Keep going down
                            }
                        }
                    }
                }

                m.x += m.vx;
                m.y += m.vy;

                // Raisin split check
                if (m.type === 'raisin' && !m.splitDone && m.y > H * 0.35 + Math.random() * H * 0.15) {
                    m.splitDone = true;
                    var childCount = 2 + (Math.random() < 0.4 ? 1 : 0);
                    for (var c = 0; c < childCount; c++) {
                        var child = spawnChildMissile(m);
                        if (child) enemyMissiles.push(child);
                    }
                    addToast('Split!', m.x, m.y - 10, '#a855f7');
                    spawnParticles(m.x, m.y, 6, '#a855f7');
                }

                // Check if reached target
                var tdist = dist(m.x, m.y, m.targetX, m.targetY);
                if (tdist < 10) {
                    // Enemy impact explosion â€” classic Missile Command burst at target
                    explosions.push({
                        x: m.targetX, y: m.targetY,
                        radius: 0, maxRadius: EXPLOSION_MAX_RADIUS * 0.7,
                        phase: 'grow', holdTimer: 6
                    });
                    if (m.targetType === 'city') {
                        if (cities[m.targetIdx].alive) {
                            cities[m.targetIdx].alive = false;
                            spawnParticles(m.targetX, m.targetY, 15, '#ef4444');
                            addToast(cities[m.targetIdx].name + ' down!', m.targetX, m.targetY - 20, '#ef4444');
                            screenFlash = 8;
                        }
                    } else if (m.targetType === 'battery') {
                        if (batteries[m.targetIdx].alive) {
                            batteries[m.targetIdx].alive = false;
                            spawnParticles(m.targetX, m.targetY, 12, '#ef4444');
                            addToast(batteries[m.targetIdx].name + ' hit!', m.targetX, m.targetY - 20, '#ef4444');
                            screenFlash = 6;
                        }
                    }
                    m.alive = false;
                    continue;
                }

                // Off screen
                if (m.y > H + 20 || m.x < -20 || m.x > W + 20) {
                    m.alive = false;
                }
            }
        }

        function getEnemyTrailColor(type) {
            if (type === 'mayo') return '#f1f5f9';
            if (type === 'raisin' || type === 'raisin_child') return '#a855f7';
            if (type === 'pineapple') return '#facc15';
            if (type === 'smart') return '#f472b6';
            return '#f1f5f9';
        }

        function drawEnemyMissiles() {
            for (var i = 0; i < enemyMissiles.length; i++) {
                var m = enemyMissiles[i];
                if (!m.alive) continue;

                var color = getEnemyTrailColor(m.type);

                // Persistent trail: solid line from start to current pos
                ctx.strokeStyle = color;
                ctx.lineWidth = 1.5;
                ctx.globalAlpha = 0.7;
                ctx.beginPath();
                ctx.moveTo(m.startX, Math.max(0, m.startY));
                ctx.lineTo(m.x, m.y);
                ctx.stroke();
                ctx.globalAlpha = 1;

                // Missile head
                var radius = 3;
                if (m.type === 'mayo') { ctx.fillStyle = '#f1f5f9'; radius = 3; }
                else if (m.type === 'raisin' || m.type === 'raisin_child') {
                    ctx.fillStyle = '#a855f7';
                    radius = m.type === 'raisin' ? 4 : 2.5;
                }
                else if (m.type === 'pineapple') { ctx.fillStyle = '#facc15'; radius = 4; }
                else if (m.type === 'smart') { ctx.fillStyle = '#f472b6'; radius = 3.5; }

                ctx.beginPath();
                ctx.arc(m.x, m.y, radius, 0, Math.PI * 2);
                ctx.fill();

                // Glow
                ctx.save();
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.arc(m.x, m.y, radius + 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   MAYO BOMBERS (wave 4+)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function spawnBomber() {
            var fromLeft = Math.random() < 0.5;
            var bY = 30 + Math.random() * 50;
            bombers.push({
                x: fromLeft ? -30 : W + 30,
                y: bY,
                vx: fromLeft ? (0.8 + Math.random() * 0.5) : -(0.8 + Math.random() * 0.5),
                alive: true,
                dropTimer: 60 + Math.floor(Math.random() * 40),
                dropCooldown: 80 + Math.floor(Math.random() * 30)
            });
        }

        function updateBombers() {
            for (var i = bombers.length - 1; i >= 0; i--) {
                var b = bombers[i];
                if (!b.alive) { bombers.splice(i, 1); continue; }

                b.x += b.vx;

                // Drop missiles periodically
                b.dropTimer--;
                if (b.dropTimer <= 0) {
                    b.dropTimer = b.dropCooldown;
                    // Drop a mayo missile from bomber position
                    var targets = getTargets();
                    var cityTargets = [];
                    for (var t = 0; t < targets.length; t++) {
                        if (targets[t].type === 'city') cityTargets.push(targets[t]);
                    }
                    if (cityTargets.length > 0) {
                        var target = cityTargets[Math.floor(Math.random() * cityTargets.length)];
                        var dx = target.x - b.x;
                        var dy = target.y - b.y;
                        var d = Math.sqrt(dx * dx + dy * dy);
                        if (d < 1) d = 1;
                        var spd = 0.8 + wave * 0.05;
                        enemyMissiles.push({
                            x: b.x, y: b.y,
                            startX: b.x, startY: b.y,
                            targetX: target.x, targetY: target.y,
                            targetType: target.type, targetIdx: target.idx,
                            type: 'mayo',
                            speed: spd,
                            vx: (dx / d) * spd, vy: (dy / d) * spd,
                            alive: true, splitDone: true
                        });
                    }
                }

                // Off screen
                if ((b.vx > 0 && b.x > W + 50) || (b.vx < 0 && b.x < -50)) {
                    b.alive = false;
                }
            }
        }

        function drawBombers() {
            for (var i = 0; i < bombers.length; i++) {
                var b = bombers[i];
                if (!b.alive) continue;

                var bx = b.x, by = b.y;
                var facing = b.vx > 0 ? 1 : -1;

                // Fuselage
                ctx.fillStyle = '#f1f5f9';
                ctx.beginPath();
                ctx.ellipse(bx, by, 16, 6, 0, 0, Math.PI * 2);
                ctx.fill();

                // Wings
                ctx.fillStyle = '#e2e8f0';
                ctx.beginPath();
                ctx.moveTo(bx - 4 * facing, by - 2);
                ctx.lineTo(bx - 12 * facing, by - 10);
                ctx.lineTo(bx + 4 * facing, by - 2);
                ctx.closePath();
                ctx.fill();

                // Tail
                ctx.beginPath();
                ctx.moveTo(bx - 14 * facing, by - 1);
                ctx.lineTo(bx - 20 * facing, by - 7);
                ctx.lineTo(bx - 12 * facing, by - 1);
                ctx.closePath();
                ctx.fill();

                // MAYO label
                ctx.font = '700 6px Inter, sans-serif';
                ctx.fillStyle = '#ef4444';
                ctx.textAlign = 'center';
                ctx.fillText('SLAW', bx, by + 3);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   COUNTER-MISSILES (PLAYER)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function findNearestBattery(targetX, targetY) {
            var best = -1;
            var bestDist = Infinity;
            for (var i = 0; i < batteries.length; i++) {
                if (!batteries[i].alive || batteries[i].ammo <= 0) continue;
                var d = dist(batteries[i].x, batteries[i].y, targetX, targetY);
                if (d < bestDist) {
                    bestDist = d;
                    best = i;
                }
            }
            return best;
        }

        function fireCounterMissile(targetX, targetY) {
            if (targetY > GROUND_Y - 20) return;

            var batIdx = findNearestBattery(targetX, targetY);
            if (batIdx < 0) return;

            var bat = batteries[batIdx];
            bat.ammo--;

            var dx = targetX - bat.x;
            var dy = targetY - (bat.y - 16);
            var d = Math.sqrt(dx * dx + dy * dy);
            if (d < 1) d = 1;

            var speed = bat.speed;
            counterMissiles.push({
                x: bat.x,
                y: bat.y - 16,
                startX: bat.x,
                startY: bat.y - 16,
                targetX: targetX,
                targetY: targetY,
                vx: (dx / d) * speed,
                vy: (dy / d) * speed,
                alive: true
            });
        }

        function updateCounterMissiles() {
            for (var i = counterMissiles.length - 1; i >= 0; i--) {
                var m = counterMissiles[i];
                if (!m.alive) { counterMissiles.splice(i, 1); continue; }

                m.x += m.vx;
                m.y += m.vy;

                // Check if reached target
                if (dist(m.x, m.y, m.targetX, m.targetY) < 6) {
                    m.alive = false;
                    explosions.push({
                        x: m.targetX, y: m.targetY,
                        radius: 0, maxRadius: EXPLOSION_MAX_RADIUS,
                        phase: 'grow', holdTimer: EXPLOSION_HOLD
                    });
                }
            }
        }

        function drawCounterMissiles() {
            for (var i = 0; i < counterMissiles.length; i++) {
                var m = counterMissiles[i];
                if (!m.alive) continue;

                // Target marker (X) at destination â€” classic Missile Command style
                ctx.strokeStyle = '#4ade80';
                ctx.lineWidth = 1.5;
                ctx.globalAlpha = 0.6;
                var tx = m.targetX, ty = m.targetY;
                ctx.beginPath();
                ctx.moveTo(tx - 5, ty - 5); ctx.lineTo(tx + 5, ty + 5);
                ctx.moveTo(tx + 5, ty - 5); ctx.lineTo(tx - 5, ty + 5);
                ctx.stroke();
                ctx.globalAlpha = 1;

                // Persistent trail: bright green line from battery to current pos
                ctx.strokeStyle = '#4ade80';
                ctx.lineWidth = 2;
                ctx.globalAlpha = 0.8;
                ctx.beginPath();
                ctx.moveTo(m.startX, m.startY);
                ctx.lineTo(m.x, m.y);
                ctx.stroke();
                ctx.globalAlpha = 1;

                // Missile head
                ctx.fillStyle = '#4ade80';
                ctx.beginPath();
                ctx.arc(m.x, m.y, 3, 0, Math.PI * 2);
                ctx.fill();

                // Bright glow
                ctx.save();
                ctx.globalAlpha = 0.5;
                ctx.fillStyle = '#4ade80';
                ctx.beginPath();
                ctx.arc(m.x, m.y, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   EXPLOSIONS (multi-color)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function updateExplosions() {
            for (var i = explosions.length - 1; i >= 0; i--) {
                var e = explosions[i];

                if (e.phase === 'grow') {
                    e.radius += EXPLOSION_GROW_SPEED;
                    if (e.radius >= e.maxRadius) {
                        e.radius = e.maxRadius;
                        e.phase = 'hold';
                    }
                } else if (e.phase === 'hold') {
                    e.holdTimer--;
                    if (e.holdTimer <= 0) e.phase = 'shrink';
                } else if (e.phase === 'shrink') {
                    e.radius -= EXPLOSION_SHRINK_SPEED;
                    if (e.radius <= 0) {
                        explosions.splice(i, 1);
                        continue;
                    }
                }

                // Check collision with enemy missiles
                for (var j = enemyMissiles.length - 1; j >= 0; j--) {
                    var m = enemyMissiles[j];
                    if (!m.alive) continue;

                    if (dist(m.x, m.y, e.x, e.y) < e.radius) {
                        m.alive = false;
                        spawnParticles(m.x, m.y, 8, getEnemyTrailColor(m.type));

                        var pts = getPoints(m.type);
                        score += pts;
                        addToast('+' + pts, m.x, m.y - 10, getEnemyTrailColor(m.type));

                        // Chain explosion
                        if (m.type !== 'raisin_child') {
                            explosions.push({
                                x: m.x, y: m.y,
                                radius: 0, maxRadius: EXPLOSION_MAX_RADIUS * 0.5,
                                phase: 'grow', holdTimer: 4
                            });
                        }
                    }
                }

                // Check collision with bombers
                for (var k = 0; k < bombers.length; k++) {
                    var bm = bombers[k];
                    if (!bm.alive) continue;
                    if (dist(bm.x, bm.y, e.x, e.y) < e.radius + 12) {
                        bm.alive = false;
                        spawnParticles(bm.x, bm.y, 15, '#f1f5f9');
                        score += 500;
                        addToast('+500 BOMBER', bm.x, bm.y - 15, '#f1f5f9');
                    }
                }
            }
        }

        function getPoints(type) {
            if (type === 'mayo') return 100;
            if (type === 'raisin') return 150;
            if (type === 'raisin_child') return 50;
            if (type === 'pineapple') return 200;
            if (type === 'smart') return 300;
            return 100;
        }

        function drawExplosions() {
            for (var i = 0; i < explosions.length; i++) {
                var e = explosions[i];
                var progress = e.radius / e.maxRadius;

                var alpha;
                if (e.phase === 'grow') alpha = 0.7;
                else if (e.phase === 'hold') alpha = 0.6;
                else alpha = (e.radius / e.maxRadius) * 0.5;

                // Outer ring â€” orange
                ctx.save();
                ctx.globalAlpha = alpha * 0.4;
                ctx.fillStyle = '#f97316';
                ctx.beginPath();
                ctx.arc(e.x, e.y, e.radius + 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();

                // Middle â€” yellow
                ctx.save();
                ctx.globalAlpha = alpha * 0.7;
                ctx.fillStyle = '#facc15';
                ctx.beginPath();
                ctx.arc(e.x, e.y, e.radius * 0.75, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();

                // Core â€” white
                ctx.save();
                ctx.globalAlpha = alpha * 0.9;
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(e.x, e.y, e.radius * 0.35, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   HUD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function drawHUD() {
            ctx.font = '600 12px Inter, sans-serif';

            // Top-left: Wave and Score
            ctx.textAlign = 'left';
            ctx.fillStyle = '#94a3b8';
            ctx.fillText('WAVE ' + wave, 12, 20);
            ctx.fillStyle = '#e2e8f0';
            ctx.font = '700 14px Inter, sans-serif';
            ctx.fillText(score, 12, 38);

            // Top-center: Ammo per battery
            ctx.textAlign = 'center';
            ctx.font = '600 11px Inter, sans-serif';

            var ammoStr = 'PC:' + (batteries[0].alive ? batteries[0].ammo : 'X');
            ammoStr += '  NA:' + (batteries[1].alive ? batteries[1].ammo : 'X');
            ammoStr += '  SC:' + (batteries[2].alive ? batteries[2].ammo : 'X');
            ctx.fillStyle = '#94a3b8';
            ctx.fillText(ammoStr, W / 2, 20);

            // Multiplier indicator
            var mult = getMultiplier();
            if (mult > 1) {
                ctx.font = '700 11px Inter, sans-serif';
                ctx.fillStyle = '#facc15';
                ctx.fillText(mult + 'x BONUS', W / 2, 34);
            }

            // Top-right: High Score
            ctx.textAlign = 'right';
            ctx.font = '600 11px Inter, sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('HI: ' + highScore, W - 12, 20);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   WAVE MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function getWaveMissileCount() {
            return 5 + (wave - 1) * 3;
        }

        function getSpawnInterval() {
            return Math.max(20, 60 - wave * 4);
        }

        function getWaveBomberCount() {
            if (wave < 4) return 0;
            return Math.min(wave - 3, 4);
        }

        function startWaveIntro() {
            state = STATE_WAVE_INTRO;
            waveIntroFrame = 0;
        }

        function startWave() {
            waveMissileCount = getWaveMissileCount();
            waveMissilesSpawned = 0;
            waveSpawnTimer = 0;
            waveSpawnInterval = getSpawnInterval();
            waveBomberCount = getWaveBomberCount();
            waveBombersSpawned = 0;
            waveBomberTimer = 90;

            // Refill batteries (rebuilt each wave, like classic)
            for (var i = 0; i < batteries.length; i++) {
                batteries[i].alive = true;
                batteries[i].ammo = AMMO_PER_BATTERY;
            }

            state = STATE_PLAYING;
        }

        function spawnWaveMissile() {
            var type = 'mayo';
            var roll = Math.random();

            if (wave >= 7 && roll < 0.15) {
                type = 'smart';
            } else if (wave >= 5 && roll < 0.25) {
                type = 'pineapple';
            } else if (wave >= 3 && roll < 0.35) {
                type = 'raisin';
            }

            spawnEnemyMissile(type);
            waveMissilesSpawned++;
        }

        function checkWaveComplete() {
            if (waveMissilesSpawned >= waveMissileCount &&
                enemyMissiles.length === 0 &&
                explosions.length === 0 &&
                bombers.length === 0) {
                // Check if any cities alive
                var anyAlive = false;
                for (var i = 0; i < cities.length; i++) {
                    if (cities[i].alive) { anyAlive = true; break; }
                }
                if (!anyAlive) {
                    triggerGameOver();
                } else {
                    // Calculate bonus
                    var mult = getMultiplier();
                    bonusCityPts = 0;
                    bonusAmmoPts = 0;
                    for (var j = 0; j < cities.length; j++) {
                        if (cities[j].alive) bonusCityPts += 100 * mult;
                    }
                    for (var k = 0; k < batteries.length; k++) {
                        if (batteries[k].alive) bonusAmmoPts += batteries[k].ammo * 5 * mult;
                    }
                    bonusTotalPts = bonusCityPts + bonusAmmoPts;

                    state = STATE_WAVE_BONUS;
                    waveBonusFrame = 0;

                    if (score > highScore) {
                        highScore = score;
                        localStorage.setItem('slaw-command-high', String(highScore));
                    }
                }
            }
        }

        function checkGameOver() {
            var anyAlive = false;
            for (var i = 0; i < cities.length; i++) {
                if (cities[i].alive) { anyAlive = true; break; }
            }
            if (!anyAlive) triggerGameOver();
        }

        function triggerGameOver() {
            state = STATE_DEAD;
            deathFrame = 0;
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('slaw-command-high', String(highScore));
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   GAME INIT / RESET
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function startGame() {
            score = 0;
            wave = 1;
            counterMissiles = [];
            enemyMissiles = [];
            explosions = [];
            particles = [];
            toasts = [];
            bombers = [];
            screenFlash = 0;
            initBatteries();
            initCities();
            startWaveIntro();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   SCREENS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function drawMenuScreen() {
            drawBackground();

            // Dark overlay
            ctx.fillStyle = 'rgba(15, 23, 42, 0.85)';
            ctx.fillRect(0, 0, W, H);

            // Title
            ctx.font = '800 36px Inter, sans-serif';
            var t1 = 'SLAW ';
            var t2 = 'COMMAND';
            var t1w = ctx.measureText(t1).width;
            var t2w = ctx.measureText(t2).width;
            var titleX = (W - t1w - t2w) / 2;
            ctx.textAlign = 'left';
            ctx.fillStyle = '#e2e8f0';
            ctx.fillText(t1, titleX, H * 0.16);
            ctx.fillStyle = '#4ade80';
            ctx.fillText(t2, titleX + t1w, H * 0.16);

            // Subtitle
            ctx.textAlign = 'center';
            ctx.font = '600 13px Inter, sans-serif';
            ctx.fillStyle = '#94a3b8';
            ctx.fillText('CYBERNETIC LOBSTERS VS. FALLING COLESLAW', W / 2, H * 0.23);

            // Preview: draw 3 batteries + 6 cities (small)
            var previewY = H * 0.32;
            ctx.save();
            for (var bi = 0; bi < 3; bi++) {
                var bx = BATTERY_X[bi];
                // Mini bunker
                ctx.fillStyle = '#334155';
                ctx.beginPath();
                ctx.moveTo(bx - 8, previewY + 2);
                ctx.lineTo(bx - 6, previewY - 4);
                ctx.lineTo(bx + 6, previewY - 4);
                ctx.lineTo(bx + 8, previewY + 2);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = bi === 1 ? '#facc15' : '#4ade80';
                ctx.beginPath();
                ctx.moveTo(bx, previewY - 9);
                ctx.lineTo(bx - 4, previewY - 4);
                ctx.lineTo(bx + 4, previewY - 4);
                ctx.closePath();
                ctx.fill();
            }
            for (var ci = 0; ci < 6; ci++) {
                var ccx = CITY_X[ci];
                // Mini lobster
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.ellipse(ccx, previewY, 6, 3, 0, 0, Math.PI * 2);
                ctx.fill();
                // Mini claws
                ctx.beginPath();
                ctx.arc(ccx - 8, previewY - 1, 2, 0, Math.PI * 2);
                ctx.arc(ccx + 8, previewY - 1, 2, 0, Math.PI * 2);
                ctx.fill();
                // Cyber eyes
                ctx.fillStyle = '#4ade80';
                ctx.beginPath();
                ctx.arc(ccx - 2, previewY - 2, 1, 0, Math.PI * 2);
                ctx.arc(ccx + 2, previewY - 2, 1, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = '600 6px Inter, sans-serif';
                ctx.fillStyle = '#64748b';
                ctx.textAlign = 'center';
                ctx.fillText(CITY_NAMES[ci], ccx, previewY + 12);
            }
            ctx.restore();

            // Enemy types legend
            var infoY = H * 0.48;
            var lineH = 20;
            ctx.textAlign = 'center';

            ctx.font = '700 11px Inter, sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('â€” ENEMY INTEL â€”', W / 2, infoY);

            infoY += lineH + 2;
            ctx.font = '600 11px Inter, sans-serif';
            ctx.fillStyle = '#f1f5f9';
            ctx.fillText('Mayo Slaw Bombs â€” 100 pts â€” "The classic white menace"', W / 2, infoY);

            infoY += lineH;
            ctx.fillStyle = '#a855f7';
            ctx.fillText('Raisin Slaw MIRVs (wave 3+) â€” 150 pts â€” "They split!"', W / 2, infoY);

            infoY += lineH;
            ctx.fillStyle = '#facc15';
            ctx.fillText('Pineapple Slaw (wave 5+) â€” 200 pts â€” "Fast & tropical"', W / 2, infoY);

            infoY += lineH;
            ctx.fillStyle = '#f472b6';
            ctx.fillText('Miracle Whip Cruise (wave 7+) â€” 300 pts â€” "Dodge-capable"', W / 2, infoY);

            infoY += lineH;
            ctx.fillStyle = '#f1f5f9';
            ctx.fillText('Slaw Bombers (wave 4+) â€” 500 pts â€” "Airborne delivery"', W / 2, infoY);

            // Start prompt
            var bounce = Math.sin(frame * 0.06) * 4;
            ctx.font = '800 16px Inter, sans-serif';
            ctx.fillStyle = '#4ade80';
            ctx.fillText('PRESS SPACE TO DEPLOY LOBSTERS', W / 2, H * 0.87 + bounce);

            ctx.font = '400 10px Inter, sans-serif';
            ctx.fillStyle = '#475569';
            ctx.fillText('or click/tap anywhere', W / 2, H * 0.87 + bounce + 16);

            // High score
            if (highScore > 0) {
                ctx.font = '700 12px Inter, sans-serif';
                ctx.fillStyle = '#64748b';
                ctx.fillText('HIGH SCORE: ' + highScore, W / 2, H * 0.96);
            }
        }

        function drawWaveIntroScreen() {
            drawBackground();

            ctx.fillStyle = 'rgba(15, 23, 42, 0.80)';
            ctx.fillRect(0, 0, W, H);

            var intro = getWaveIntro(wave);

            // Wave number
            ctx.textAlign = 'center';
            ctx.font = '600 14px Inter, sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('WAVE ' + wave, W / 2, H * 0.34);

            // Title
            ctx.font = '800 28px Inter, sans-serif';
            ctx.fillStyle = '#ef4444';
            ctx.fillText(intro.title, W / 2, H * 0.46);

            // Subtitle
            ctx.font = '400 14px Inter, sans-serif';
            ctx.fillStyle = '#94a3b8';
            ctx.fillText(intro.sub, W / 2, H * 0.56);

            // Multiplier
            var mult = getMultiplier();
            if (mult > 1) {
                ctx.font = '700 13px Inter, sans-serif';
                ctx.fillStyle = '#facc15';
                ctx.fillText('BONUS MULTIPLIER: ' + mult + 'x', W / 2, H * 0.66);
            }
        }

        function drawWaveBonusScreen() {
            drawBackground();

            // Draw cities in place so player sees what survived
            drawCities();
            drawBatteries();

            ctx.fillStyle = 'rgba(15, 23, 42, 0.75)';
            ctx.fillRect(0, 0, W, H);

            ctx.textAlign = 'center';

            // Title
            ctx.font = '800 26px Inter, sans-serif';
            ctx.fillStyle = '#4ade80';
            ctx.fillText('BONUS SHREDS', W / 2, H * 0.18);

            var mult = getMultiplier();
            ctx.font = '600 12px Inter, sans-serif';
            ctx.fillStyle = '#94a3b8';
            ctx.fillText('Wave ' + wave + ' Complete â€” ' + mult + 'x Multiplier', W / 2, H * 0.26);

            // Surviving cities
            var cityY = H * 0.35;
            ctx.font = '700 11px Inter, sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('SURVIVING LOBSTERS', W / 2, cityY);

            cityY += 18;
            var animProgress = Math.min(waveBonusFrame / 60, 1); // count-up over ~1 sec
            var cityCount = 0;
            for (var i = 0; i < cities.length; i++) {
                if (cities[i].alive) cityCount++;
            }

            // Draw each surviving city name
            var aliveNames = [];
            for (var j = 0; j < cities.length; j++) {
                if (cities[j].alive) aliveNames.push(cities[j].name);
            }
            if (aliveNames.length > 0) {
                ctx.font = '600 10px Inter, sans-serif';
                ctx.fillStyle = '#4ade80';
                ctx.fillText(aliveNames.join('  â€¢  '), W / 2, cityY);
            } else {
                ctx.font = '600 10px Inter, sans-serif';
                ctx.fillStyle = '#64748b';
                ctx.fillText('No lobsters survived', W / 2, cityY);
            }

            cityY += 22;
            var displayedCityPts = Math.floor(bonusCityPts * animProgress);
            ctx.font = '700 14px Inter, sans-serif';
            ctx.fillStyle = '#4ade80';
            ctx.fillText(cityCount + ' lobsters Ã— ' + (100 * mult) + ' = ' + displayedCityPts + ' pts', W / 2, cityY);

            // Remaining ammo
            cityY += 30;
            ctx.font = '700 11px Inter, sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('REMAINING AMMO', W / 2, cityY);

            cityY += 18;
            var totalAmmo = 0;
            for (var k = 0; k < batteries.length; k++) {
                if (batteries[k].alive) totalAmmo += batteries[k].ammo;
            }
            var displayedAmmoPts = Math.floor(bonusAmmoPts * animProgress);
            ctx.font = '700 14px Inter, sans-serif';
            ctx.fillStyle = '#facc15';
            ctx.fillText(totalAmmo + ' missiles Ã— ' + (5 * mult) + ' = ' + displayedAmmoPts + ' pts', W / 2, cityY);

            // Total bonus
            cityY += 32;
            var displayedTotal = Math.floor(bonusTotalPts * animProgress);
            ctx.font = '800 18px Inter, sans-serif';
            ctx.fillStyle = '#e2e8f0';
            ctx.fillText('TOTAL BONUS: ' + displayedTotal, W / 2, cityY);

            // "Next wave" prompt after animation
            if (waveBonusFrame > 120) {
                var bounce = Math.sin(frame * 0.06) * 3;
                ctx.font = '600 12px Inter, sans-serif';
                ctx.fillStyle = '#4ade80';
                ctx.fillText('Next wave incoming...', W / 2, H * 0.88 + bounce);
            }
        }

        function drawGameOverScreen() {
            ctx.fillStyle = 'rgba(15, 23, 42, 0.85)';
            ctx.fillRect(0, 0, W, H);

            ctx.textAlign = 'center';

            // Big dramatic title
            ctx.font = '800 34px Inter, sans-serif';
            ctx.fillStyle = '#ef4444';
            ctx.fillText('THE LOBSTERS HAVE BEEN SLAWED', W / 2, H * 0.30);

            // Subtitle
            ctx.font = '400 13px Inter, sans-serif';
            ctx.fillStyle = '#94a3b8';
            ctx.fillText('All cybernetic lobsters have been dressed.', W / 2, H * 0.38);

            // Stats
            ctx.font = '700 16px Inter, sans-serif';
            ctx.fillStyle = '#e2e8f0';
            ctx.fillText('Final Score: ' + score, W / 2, H * 0.50);

            ctx.font = '600 13px Inter, sans-serif';
            ctx.fillStyle = '#94a3b8';
            ctx.fillText('Wave Reached: ' + wave, W / 2, H * 0.57);

            ctx.font = '700 13px Inter, sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('High Score: ' + highScore, W / 2, H * 0.63);

            // New high score flash
            if (score >= highScore && score > 0) {
                var flashAlpha = 0.5 + 0.5 * Math.sin(frame * 0.1);
                ctx.save();
                ctx.globalAlpha = flashAlpha;
                ctx.font = '800 14px Inter, sans-serif';
                ctx.fillStyle = '#facc15';
                ctx.fillText('â˜… NEW HIGH SCORE â˜…', W / 2, H * 0.70);
                ctx.restore();
            }

            // Retry prompt
            if (deathFrame > 50) {
                var bounce = Math.sin(frame * 0.06) * 4;
                ctx.font = '800 15px Inter, sans-serif';
                ctx.fillStyle = '#4ade80';
                ctx.fillText('PRESS SPACE TO REBOOT LOBSTERS', W / 2, H * 0.82 + bounce);

                ctx.font = '400 10px Inter, sans-serif';
                ctx.fillStyle = '#475569';
                ctx.fillText('or click/tap', W / 2, H * 0.82 + bounce + 18);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   CROSSHAIR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function drawCrosshair() {
            if (state !== STATE_PLAYING) return;

            ctx.save();
            ctx.globalAlpha = 0.4;
            ctx.strokeStyle = '#4ade80';
            ctx.lineWidth = 1;

            var size = 8;
            ctx.beginPath();
            ctx.moveTo(mouseX - size, mouseY);
            ctx.lineTo(mouseX + size, mouseY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(mouseX, mouseY - size);
            ctx.lineTo(mouseX, mouseY + size);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(mouseX, mouseY, size + 2, 0, Math.PI * 2);
            ctx.stroke();

            ctx.restore();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   SCREEN FLASH
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function drawScreenFlash() {
            if (screenFlash > 0) {
                ctx.save();
                ctx.globalAlpha = screenFlash * 0.04;
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, W, H);
                ctx.restore();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   UPDATE & DRAW
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function update() {
            frame++;
            if (screenFlash > 0) screenFlash--;

            if (state === STATE_PLAYING) {
                // Spawn enemy missiles
                if (waveMissilesSpawned < waveMissileCount) {
                    waveSpawnTimer++;
                    if (waveSpawnTimer >= waveSpawnInterval) {
                        waveSpawnTimer = 0;
                        spawnWaveMissile();
                    }
                }

                // Spawn bombers
                if (waveBombersSpawned < waveBomberCount) {
                    waveBomberTimer--;
                    if (waveBomberTimer <= 0) {
                        spawnBomber();
                        waveBombersSpawned++;
                        waveBomberTimer = 120 + Math.floor(Math.random() * 60);
                    }
                }

                updateCounterMissiles();
                updateEnemyMissiles();
                updateBombers();
                updateExplosions();
                updateParticles();
                updateToasts();

                checkGameOver();
                if (state === STATE_PLAYING) checkWaveComplete();

            } else if (state === STATE_WAVE_INTRO) {
                waveIntroFrame++;
                if (waveIntroFrame > 120) { // ~2 seconds
                    startWave();
                }
            } else if (state === STATE_WAVE_BONUS) {
                waveBonusFrame++;
                updateParticles();
                updateToasts();

                // Award bonus points gradually
                if (waveBonusFrame === 60) {
                    score += bonusTotalPts;
                    if (score > highScore) {
                        highScore = score;
                        localStorage.setItem('slaw-command-high', String(highScore));
                    }
                }

                if (waveBonusFrame > 180) {
                    wave++;
                    startWaveIntro();
                }
            } else if (state === STATE_DEAD) {
                deathFrame++;
                updateParticles();
                updateToasts();
            } else if (state === STATE_MENU) {
                updateToasts();
            }
        }

        function draw() {
            if (state === STATE_MENU) {
                drawMenuScreen();
                return;
            }

            if (state === STATE_WAVE_INTRO) {
                drawWaveIntroScreen();
                return;
            }

            drawBackground();

            // Draw game elements
            drawCities();
            drawBatteries();
            drawEnemyMissiles();
            drawCounterMissiles();
            drawBombers();
            drawExplosions();
            drawParticles();
            drawCrosshair();
            drawHUD();
            drawToasts();
            drawScreenFlash();

            if (state === STATE_WAVE_BONUS) {
                drawWaveBonusScreen();
            } else if (state === STATE_DEAD) {
                drawGameOverScreen();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   INPUT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function getCanvasPos(clientX, clientY) {
            var rect = canvas.getBoundingClientRect();
            var scaleX = W / rect.width;
            var scaleY = H / rect.height;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        canvas.addEventListener('mousemove', function(e) {
            var pos = getCanvasPos(e.clientX, e.clientY);
            mouseX = pos.x;
            mouseY = pos.y;
        });

        canvas.addEventListener('click', function(e) {
            e.preventDefault();
            var pos = getCanvasPos(e.clientX, e.clientY);

            if (state === STATE_MENU) { startGame(); return; }
            if (state === STATE_DEAD && deathFrame > 50) { startGame(); return; }
            if (state === STATE_PLAYING) { fireCounterMissile(pos.x, pos.y); }
        });

        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            if (e.touches.length > 0) {
                var pos = getCanvasPos(e.touches[0].clientX, e.touches[0].clientY);
                mouseX = pos.x;
                mouseY = pos.y;

                if (state === STATE_MENU) { startGame(); return; }
                if (state === STATE_DEAD && deathFrame > 50) { startGame(); return; }
                if (state === STATE_PLAYING) { fireCounterMissile(pos.x, pos.y); }
            }
        }, { passive: false });

        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' || e.key === ' ') {
                e.preventDefault();
                if (state === STATE_MENU) startGame();
                else if (state === STATE_DEAD && deathFrame > 50) startGame();
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //   GAME LOOP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        initBatteries();
        initCities();
        loop();
    })();
    </script>
</body>
</html>
