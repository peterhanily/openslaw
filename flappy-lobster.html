<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Lobster - OpenSlaw.ai</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .game-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .game-header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .game-header h1 span {
            color: #4ade80;
        }

        .game-header p {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .game-container {
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(22, 163, 74, 0.15), 0 0 0 1px rgba(255,255,255,0.05);
        }

        canvas { display: block; }

        .game-footer {
            text-align: center;
            margin-top: 1rem;
        }

        .game-footer a {
            color: #4ade80;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .game-footer a:hover { text-decoration: underline; }

        .controls-hint {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1>ü¶û Flappy <span>Lobster</span></h1>
        <p>Deploy your agentic lobster. Dodge the bad ingredients.</p>
    </div>
    <div class="game-container">
        <canvas id="game" width="400" height="600"></canvas>
    </div>
    <div class="game-footer">
        <a href="/">‚Üê Back to OpenSlaw.ai</a>
        <div class="controls-hint">Space / Click / Tap to flap</div>
    </div>

    <script>
    (function() {
        var canvas = document.getElementById('game');
        var ctx = canvas.getContext('2d');
        var W = canvas.width;
        var H = canvas.height;

        var STATE_MENU = 0, STATE_PLAYING = 1, STATE_DEAD = 2;
        var state = STATE_MENU;
        var score = 0;
        var highScore = parseInt(localStorage.getItem('flappy-lobster-high') || '0');
        var frameCount = 0;
        var globalFrame = 0;

        var GROUND_H = 55;
        var groundX = 0;

        // Lobster (slightly bigger for the custom sprite)
        var lobster = { x: 80, y: 300, w: 46, h: 36, vy: 0, rotation: 0 };
        var GRAVITY = 0.45;
        var FLAP_POWER = -7.5;
        var MAX_FALL = 10;

        // Pipes
        var pipes = [];
        var PIPE_W = 62;
        var PIPE_GAP = 155;
        var pipeSpeed = 2.5;
        var PIPE_SPAWN = 100;
        var pipeTimer = 0;

        var PIPE_TYPES = [
            { name: 'mayo',      color: '#fefce8', dark: '#fde68a', highlight: '#fffbeb', lip: '#eab308', emoji: 'ü•õ', label: 'MAYO',         deathMsg: "Mayo'd!" },
            { name: 'raisin',    color: '#7c3aed', dark: '#6d28d9', highlight: '#a78bfa', lip: '#5b21b6', emoji: 'üçá', label: 'RAISINS',      deathMsg: "Raisin'd!" },
            { name: 'pineapple', color: '#f59e0b', dark: '#d97706', highlight: '#fbbf24', lip: '#b45309', emoji: 'üçç', label: 'PINEAPPLE',    deathMsg: "Pineapple'd!" },
            { name: 'badslaw',   color: '#64748b', dark: '#475569', highlight: '#94a3b8', lip: '#334155', emoji: 'ü•ó', label: 'LEGACY SLAW',  deathMsg: 'Legacy slaw!' },
            { name: 'marsh',     color: '#fecdd3', dark: '#fda4af', highlight: '#fff1f2', lip: '#e11d48', emoji: 'ü§ç', label: 'MARSHMALLOWS', deathMsg: "Marshmallow'd!" },
        ];
        var lastDeathMsg = '';

        // Collectibles
        var cabbages = [];
        var CABBAGE_SIZE = 24;

        // Particles (emoji + jet)
        var particles = [];

        // Floating text toasts
        var toasts = [];

        // Score milestones
        var milestones = [
            { at: 3,  msg: 'Crunch factor rising!' },
            { at: 5,  msg: 'Mayo resistance: STRONG' },
            { at: 10, msg: 'Promoted to Slaw Engineer' },
            { at: 15, msg: 'VP of Dodging' },
            { at: 20, msg: 'Lobster-slaw synergy: 10x' },
            { at: 25, msg: 'Principal Evasion Architect' },
            { at: 30, msg: 'Approaching AGC...' },
            { at: 40, msg: 'Is this even possible?' },
            { at: 50, msg: 'You ARE the coleslaw now' },
        ];
        var milestonesHit = {};

        // Background ingredients
        var bgIngredients = [];
        var BG_EMOJIS = ['ü•¨','ü•ï','üçã','üßÇ','üåø','ü•¨','ü•¨','ü•ï'];
        for (var i = 0; i < 20; i++) {
            bgIngredients.push({
                x: Math.random() * W,
                y: Math.random() * (H - GROUND_H),
                size: 12 + Math.random() * 20,
                speed: 0.2 + Math.random() * 0.6,
                opacity: 0.04 + Math.random() * 0.07,
                emoji: BG_EMOJIS[Math.floor(Math.random() * BG_EMOJIS.length)],
                wobble: Math.random() * Math.PI * 2
            });
        }

        // Background recipe text
        var recipeSnippets = [
            'thinly sliced','julienned','zested','emulsified',
            'fork-friendly','cold-start','no hallucinations',
            'citrus-forward','agentic','lobster-optimized',
            'crunch factor','deploy to fridge','inference: 30 min',
            'agent.shred()','slaw.deploy()','crunch++',
        ];
        var bgTexts = [];
        for (var i = 0; i < 8; i++) {
            bgTexts.push({
                x: Math.random() * W,
                y: 60 + Math.random() * (H - GROUND_H - 120),
                speed: 0.15 + Math.random() * 0.3,
                opacity: 0.04 + Math.random() * 0.04,
                text: recipeSnippets[Math.floor(Math.random() * recipeSnippets.length)]
            });
        }

        // ‚îÄ‚îÄ Trail positions for lobster afterimage ‚îÄ‚îÄ
        var trail = [];
        var TRAIL_LEN = 6;

        function reset() {
            lobster.y = H / 2;
            lobster.vy = 0;
            lobster.rotation = 0;
            pipes = [];
            cabbages = [];
            particles = [];
            toasts = [];
            trail = [];
            pipeTimer = PIPE_SPAWN - 30;
            score = 0;
            pipeSpeed = 2.5;
            frameCount = 0;
            milestonesHit = {};
            lastDeathMsg = '';
        }

        function spawnJetParticles() {
            for (var i = 0; i < 6; i++) {
                particles.push({
                    x: lobster.x + lobster.w * 0.35 + Math.random() * 8,
                    y: lobster.y + lobster.h * 0.8,
                    vx: (Math.random() - 0.5) * 1.5,
                    vy: 2 + Math.random() * 3,
                    life: 10 + Math.random() * 10,
                    maxLife: 20,
                    isJet: true,
                    emoji: '', size: 0
                });
            }
        }

        function flap() {
            if (state === STATE_MENU) {
                state = STATE_PLAYING;
                reset();
                lobster.vy = FLAP_POWER;
                spawnJetParticles();
            } else if (state === STATE_PLAYING) {
                lobster.vy = FLAP_POWER;
                spawnJetParticles();
            } else if (state === STATE_DEAD && frameCount > 30) {
                state = STATE_MENU;
            }
        }

        // Input
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); flap(); }
        });
        canvas.addEventListener('click', flap);
        canvas.addEventListener('touchstart', function(e) { e.preventDefault(); flap(); });

        function spawnPipe() {
            var minY = 80;
            var maxY = H - GROUND_H - PIPE_GAP - 80;
            var topH = minY + Math.random() * (maxY - minY);
            var type = PIPE_TYPES[Math.floor(Math.random() * PIPE_TYPES.length)];
            pipes.push({ x: W + 10, topH: topH, scored: false, type: type });
            if (Math.random() < 0.35) {
                cabbages.push({
                    x: W + 10 + PIPE_W / 2 - CABBAGE_SIZE / 2,
                    y: topH + PIPE_GAP / 2 - CABBAGE_SIZE / 2,
                    collected: false, sparkle: 0
                });
            }
        }

        function addToast(msg, x, y, color) {
            toasts.push({ msg: msg, x: x, y: y, life: 50, color: color || '#4ade80' });
        }

        function createDeathParticles() {
            // Mechanical explosion
            var emojis = ['‚ö°','‚ú®','üí•','üî©','‚öôÔ∏è','üîß'];
            for (var i = 0; i < 24; i++) {
                particles.push({
                    x: lobster.x + lobster.w / 2,
                    y: lobster.y + lobster.h / 2,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10 - 3,
                    life: 50 + Math.random() * 40,
                    maxLife: 90,
                    emoji: emojis[Math.floor(Math.random() * emojis.length)],
                    size: 10 + Math.random() * 16,
                    isJet: false
                });
            }
            // Sparks
            for (var i = 0; i < 15; i++) {
                particles.push({
                    x: lobster.x + lobster.w / 2,
                    y: lobster.y + lobster.h / 2,
                    vx: (Math.random() - 0.5) * 12,
                    vy: (Math.random() - 0.5) * 12,
                    life: 15 + Math.random() * 15,
                    maxLife: 30,
                    isJet: true, isSpark: true,
                    emoji: '', size: 0
                });
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //   DRAW CYBERNETIC LOBSTER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function drawLobster(x, y, w, h, rot, alpha) {
            ctx.save();
            ctx.globalAlpha = alpha !== undefined ? alpha : 1;
            ctx.translate(x + w/2, y + h/2);
            ctx.rotate(rot);

            var pulse = Math.sin(globalFrame * 0.12) * 0.3 + 0.7;

            // ‚îÄ‚îÄ Green propulsion glow (underneath) ‚îÄ‚îÄ
            var glowR = w * 0.6;
            var grd = ctx.createRadialGradient(0, 2, 3, 0, 2, glowR);
            grd.addColorStop(0, 'rgba(74, 222, 128, ' + (0.2 * pulse) + ')');
            grd.addColorStop(1, 'rgba(74, 222, 128, 0)');
            ctx.fillStyle = grd;
            ctx.beginPath();
            ctx.arc(0, 2, glowR, 0, Math.PI * 2);
            ctx.fill();

            // ‚îÄ‚îÄ Tail fan (left side) ‚îÄ‚îÄ
            ctx.fillStyle = '#b91c1c';
            for (var t = -1; t <= 1; t++) {
                ctx.beginPath();
                ctx.ellipse(-w * 0.38, t * 5, 7, 3.5, -0.15, 0, Math.PI * 2);
                ctx.fill();
            }
            // Tail connector with armor plate
            ctx.fillStyle = '#991b1b';
            ctx.fillRect(-w * 0.30, -5, 7, 10);
            ctx.fillStyle = '#dc2626';
            ctx.fillRect(-w * 0.30, -5, 7, 2);

            // ‚îÄ‚îÄ Body segments (armored plating) ‚îÄ‚îÄ
            // Back segment
            ctx.fillStyle = '#dc2626';
            ctx.beginPath();
            ctx.ellipse(-w * 0.1, 0, 9, h * 0.34, 0, 0, Math.PI * 2);
            ctx.fill();

            // Main body
            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.ellipse(w * 0.05, 0, 12, h * 0.38, 0, 0, Math.PI * 2);
            ctx.fill();

            // Metallic highlight
            var mg = ctx.createLinearGradient(0, -h*0.38, 0, h*0.38);
            mg.addColorStop(0, 'rgba(255,200,200,0.35)');
            mg.addColorStop(0.4, 'rgba(255,255,255,0.1)');
            mg.addColorStop(1, 'rgba(0,0,0,0.25)');
            ctx.fillStyle = mg;
            ctx.beginPath();
            ctx.ellipse(w * 0.05, 0, 12, h * 0.38, 0, 0, Math.PI * 2);
            ctx.fill();

            // Armor segment lines
            ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            ctx.lineWidth = 0.8;
            ctx.beginPath();
            ctx.moveTo(-w * 0.05, -h * 0.3);
            ctx.lineTo(-w * 0.05, h * 0.3);
            ctx.stroke();

            // ‚îÄ‚îÄ Circuit board lines (cybernetic) ‚îÄ‚îÄ
            ctx.strokeStyle = 'rgba(74, 222, 128, ' + (0.6 * pulse) + ')';
            ctx.lineWidth = 1;
            // Main bus
            ctx.beginPath();
            ctx.moveTo(-w * 0.15, 0);
            ctx.lineTo(w * 0.18, 0);
            ctx.stroke();
            // Branch up
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(w * 0.06, -h * 0.2);
            ctx.lineTo(w * 0.14, -h * 0.2);
            ctx.stroke();
            // Branch down
            ctx.beginPath();
            ctx.moveTo(-w * 0.06, 0);
            ctx.lineTo(-w * 0.02, h * 0.18);
            ctx.stroke();
            // Circuit nodes
            ctx.fillStyle = 'rgba(74, 222, 128, ' + (0.8 * pulse) + ')';
            var nodes = [[w*0.14, -h*0.2], [-w*0.02, h*0.18], [-w*0.15, 0], [w*0.18, 0]];
            for (var n = 0; n < nodes.length; n++) {
                ctx.beginPath();
                ctx.arc(nodes[n][0], nodes[n][1], 1.5, 0, Math.PI * 2);
                ctx.fill();
            }

            // ‚îÄ‚îÄ Legs (mechanical, underneath) ‚îÄ‚îÄ
            ctx.strokeStyle = '#991b1b';
            ctx.lineWidth = 1.5;
            for (var l = -1; l <= 1; l++) {
                var lx2 = l * 7;
                ctx.beginPath();
                ctx.moveTo(lx2, h * 0.28);
                ctx.lineTo(lx2 + l * 2, h * 0.48);
                ctx.stroke();
                // Joint dot
                ctx.fillStyle = '#7f1d1d';
                ctx.beginPath();
                ctx.arc(lx2, h * 0.28, 1.2, 0, Math.PI * 2);
                ctx.fill();
            }

            // ‚îÄ‚îÄ Head (right side) ‚îÄ‚îÄ
            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.ellipse(w * 0.2, 0, 6, 7, 0, 0, Math.PI * 2);
            ctx.fill();
            // Head armor highlight
            var hg = ctx.createLinearGradient(w*0.14, -7, w*0.26, 7);
            hg.addColorStop(0, 'rgba(255,200,200,0.3)');
            hg.addColorStop(1, 'rgba(0,0,0,0.2)');
            ctx.fillStyle = hg;
            ctx.beginPath();
            ctx.ellipse(w * 0.2, 0, 6, 7, 0, 0, Math.PI * 2);
            ctx.fill();

            // ‚îÄ‚îÄ Claws (mechanical pincers with green energy tips) ‚îÄ‚îÄ
            ctx.lineWidth = 2.5;
            ctx.lineCap = 'round';

            // Top claw
            ctx.strokeStyle = '#dc2626';
            ctx.beginPath();
            ctx.moveTo(w * 0.24, -5);
            ctx.lineTo(w * 0.42, -13);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(w * 0.42, -13);
            ctx.lineTo(w * 0.34, -5);
            ctx.stroke();
            // Energy tip
            ctx.fillStyle = '#4ade80';
            ctx.shadowColor = '#4ade80';
            ctx.shadowBlur = 5 * pulse;
            ctx.beginPath();
            ctx.arc(w * 0.42, -13, 2.5, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // Bottom claw
            ctx.strokeStyle = '#dc2626';
            ctx.beginPath();
            ctx.moveTo(w * 0.24, 5);
            ctx.lineTo(w * 0.42, 13);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(w * 0.42, 13);
            ctx.lineTo(w * 0.34, 5);
            ctx.stroke();
            ctx.fillStyle = '#4ade80';
            ctx.shadowColor = '#4ade80';
            ctx.shadowBlur = 5 * pulse;
            ctx.beginPath();
            ctx.arc(w * 0.42, 13, 2.5, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // ‚îÄ‚îÄ Antenna (sensor arrays) ‚îÄ‚îÄ
            ctx.strokeStyle = '#b91c1c';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(w * 0.18, -h * 0.3);
            ctx.lineTo(w * 0.30, -h * 0.6);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(w * 0.14, -h * 0.3);
            ctx.lineTo(w * 0.06, -h * 0.65);
            ctx.stroke();
            // LED tips
            ctx.fillStyle = '#4ade80';
            ctx.shadowColor = '#4ade80';
            ctx.shadowBlur = 4;
            ctx.beginPath();
            ctx.arc(w * 0.30, -h * 0.6, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(w * 0.06, -h * 0.65, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // ‚îÄ‚îÄ Cybernetic Eye ‚îÄ‚îÄ
            // Eye socket (dark)
            ctx.fillStyle = '#1e293b';
            ctx.beginPath();
            ctx.arc(w * 0.21, -2, 4.5, 0, Math.PI * 2);
            ctx.fill();
            // Outer ring
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(w * 0.21, -2, 4.5, 0, Math.PI * 2);
            ctx.stroke();
            // Glowing iris
            ctx.fillStyle = '#4ade80';
            ctx.shadowColor = '#4ade80';
            ctx.shadowBlur = 8;
            ctx.beginPath();
            ctx.arc(w * 0.21, -2, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            // Inner bright
            ctx.fillStyle = '#bbf7d0';
            ctx.beginPath();
            ctx.arc(w * 0.21, -2, 1.5, 0, Math.PI * 2);
            ctx.fill();
            // Pupil slit
            ctx.fillStyle = '#052e16';
            ctx.fillRect(w * 0.21 - 0.5, -4.5, 1, 5);
            // Specular highlight
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.beginPath();
            ctx.arc(w * 0.19, -3.5, 1, 0, Math.PI * 2);
            ctx.fill();

            // ‚îÄ‚îÄ Small "AI" badge on body ‚îÄ‚îÄ
            if (pulse > 0.8) {
                ctx.font = '700 5px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillStyle = 'rgba(74, 222, 128, ' + ((pulse - 0.5) * 0.8) + ')';
                ctx.fillText('AI', -w * 0.1, 2.5);
            }

            ctx.restore();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //   DRAWING FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function drawBackground() {
            var grad = ctx.createLinearGradient(0, 0, 0, H - GROUND_H);
            grad.addColorStop(0, '#0c1222');
            grad.addColorStop(0.5, '#162032');
            grad.addColorStop(1, '#1a2a3a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, W, H);

            // Kitchen tile grid
            ctx.strokeStyle = 'rgba(255,255,255,0.015)';
            ctx.lineWidth = 1;
            for (var ty = 0; ty < H - GROUND_H; ty += 40) {
                ctx.beginPath(); ctx.moveTo(0, ty); ctx.lineTo(W, ty); ctx.stroke();
            }
            for (var tx = 0; tx < W; tx += 40) {
                ctx.beginPath(); ctx.moveTo(tx, 0); ctx.lineTo(tx, H - GROUND_H); ctx.stroke();
            }

            // Recipe text
            ctx.font = '600 11px Inter, sans-serif';
            ctx.textAlign = 'left';
            for (var i = 0; i < bgTexts.length; i++) {
                var t = bgTexts[i];
                t.x -= t.speed;
                if (t.x < -150) {
                    t.x = W + 20;
                    t.y = 60 + Math.random() * (H - GROUND_H - 120);
                    t.text = recipeSnippets[Math.floor(Math.random() * recipeSnippets.length)];
                }
                ctx.fillStyle = 'rgba(74, 222, 128, ' + t.opacity + ')';
                ctx.fillText(t.text, t.x, t.y);
            }

            // Floating emojis
            for (var i = 0; i < bgIngredients.length; i++) {
                var b = bgIngredients[i];
                b.x -= b.speed;
                b.wobble += 0.015;
                if (b.x < -30) { b.x = W + 30; b.y = Math.random() * (H - GROUND_H); }
                ctx.globalAlpha = b.opacity;
                ctx.font = b.size + 'px serif';
                ctx.textAlign = 'center';
                ctx.fillText(b.emoji, b.x, b.y + Math.sin(b.wobble) * 8);
            }
            ctx.globalAlpha = 1;
        }

        function drawGround() {
            var gy = H - GROUND_H;
            ctx.fillStyle = '#92400e';
            ctx.fillRect(0, gy, W, GROUND_H);
            var grainColors = ['#78350f','#a16207','#854d0e','#713f12'];
            for (var g = 0; g < 8; g++) {
                ctx.fillStyle = grainColors[g % grainColors.length];
                ctx.globalAlpha = 0.3;
                ctx.fillRect(groundX % 80 - 80, gy + 6 + g * 7, W + 160, 2);
            }
            ctx.globalAlpha = 1;
            ctx.fillStyle = '#d97706';
            ctx.fillRect(0, gy, W, 3);
            ctx.fillStyle = '#451a03';
            ctx.fillRect(0, H - 4, W, 4);
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            for (var nx = groundX % 30 - 30; nx < W; nx += 30) {
                ctx.fillRect(nx, gy + 3, 1, GROUND_H);
            }
        }

        function drawPipe(pipe) {
            var x = pipe.x, topH = pipe.topH, botY = topH + PIPE_GAP;
            var botH = H - GROUND_H - botY, t = pipe.type;

            // Top pipe
            ctx.fillStyle = t.color;
            ctx.fillRect(x, 0, PIPE_W, topH);
            ctx.fillStyle = t.highlight;
            ctx.fillRect(x, 0, 5, topH);
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(x + PIPE_W - 5, 0, 5, topH);
            ctx.fillStyle = t.lip;
            ctx.fillRect(x - 5, topH - 22, PIPE_W + 10, 22);
            ctx.fillStyle = t.dark;
            ctx.fillRect(x - 5, topH - 22, PIPE_W + 10, 4);
            ctx.font = '16px serif';
            ctx.textAlign = 'center';
            for (var ey = 20; ey < topH - 30; ey += 45) {
                ctx.globalAlpha = 0.6;
                ctx.fillText(t.emoji, x + PIPE_W/2, ey);
            }
            ctx.globalAlpha = 1;
            ctx.font = '22px serif';
            ctx.fillText(t.emoji, x + PIPE_W/2, topH - 10);
            ctx.save();
            ctx.font = '800 8px Inter, sans-serif';
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.textAlign = 'center';
            ctx.translate(x + PIPE_W/2, Math.min(topH/2, topH - 40));
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(t.label, 0, 0);
            ctx.restore();

            // Bottom pipe
            ctx.fillStyle = t.color;
            ctx.fillRect(x, botY, PIPE_W, botH);
            ctx.fillStyle = t.highlight;
            ctx.fillRect(x, botY, 5, botH);
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(x + PIPE_W - 5, botY, 5, botH);
            ctx.fillStyle = t.lip;
            ctx.fillRect(x - 5, botY, PIPE_W + 10, 22);
            ctx.fillStyle = t.dark;
            ctx.fillRect(x - 5, botY + 18, PIPE_W + 10, 4);
            ctx.font = '16px serif';
            ctx.textAlign = 'center';
            for (var ey = botY + 40; ey < H - GROUND_H - 20; ey += 45) {
                ctx.globalAlpha = 0.6;
                ctx.fillText(t.emoji, x + PIPE_W/2, ey);
            }
            ctx.globalAlpha = 1;
            ctx.font = '22px serif';
            ctx.fillText(t.emoji, x + PIPE_W/2, botY + 14);
        }

        function drawCabbages() {
            for (var i = 0; i < cabbages.length; i++) {
                var c = cabbages[i];
                if (c.collected) continue;
                c.sparkle += 0.08;
                var glowSize = 18 + Math.sin(c.sparkle) * 4;
                ctx.beginPath();
                var grd = ctx.createRadialGradient(
                    c.x + CABBAGE_SIZE/2, c.y + CABBAGE_SIZE/2, 2,
                    c.x + CABBAGE_SIZE/2, c.y + CABBAGE_SIZE/2, glowSize
                );
                grd.addColorStop(0, 'rgba(74, 222, 128, 0.3)');
                grd.addColorStop(1, 'rgba(74, 222, 128, 0)');
                ctx.fillStyle = grd;
                ctx.arc(c.x + CABBAGE_SIZE/2, c.y + CABBAGE_SIZE/2, glowSize, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = CABBAGE_SIZE + 'px serif';
                ctx.textAlign = 'center';
                ctx.fillText('ü•¨', c.x + CABBAGE_SIZE/2, c.y + CABBAGE_SIZE/2 + Math.sin(c.sparkle) * 3 + 6);
            }
        }

        function drawScore() {
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.font = '700 10px Inter, sans-serif';
            ctx.fillStyle = 'rgba(148, 163, 184, 0.6)';
            ctx.fillText('SLAWS DODGED', W/2, 14);
            ctx.font = '800 48px Inter, sans-serif';
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillText(score, W/2 + 2, 28);
            ctx.fillStyle = 'white';
            ctx.fillText(score, W/2, 26);
        }

        function drawToasts() {
            for (var i = toasts.length - 1; i >= 0; i--) {
                var t = toasts[i];
                t.y -= 0.8;
                t.life--;
                if (t.life <= 0) { toasts.splice(i, 1); continue; }
                ctx.globalAlpha = Math.min(1, t.life / 15);
                ctx.font = '700 14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillStyle = t.color;
                ctx.fillText(t.msg, t.x, t.y);
            }
            ctx.globalAlpha = 1;
        }

        function drawParticles() {
            for (var i = particles.length - 1; i >= 0; i--) {
                var p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += p.isJet ? 0.1 : 0.2;
                p.life--;
                if (p.life <= 0) { particles.splice(i, 1); continue; }
                var alpha = p.life / p.maxLife;
                ctx.globalAlpha = alpha;
                if (p.isJet) {
                    // Drawn particle (jet exhaust or spark)
                    var r = p.isSpark ? (1 + (1 - alpha) * 2) : (2 + (1 - alpha) * 4);
                    if (p.isSpark) {
                        ctx.fillStyle = globalFrame % 2 === 0 ? '#fbbf24' : '#4ade80';
                    } else {
                        // Green jet that fades to cyan
                        var g = Math.floor(180 + alpha * 42);
                        ctx.fillStyle = 'rgba(74, ' + g + ', 128, 1)';
                    }
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.font = p.size + 'px serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(p.emoji, p.x, p.y);
                }
            }
            ctx.globalAlpha = 1;
        }

        function drawTrail() {
            for (var i = 0; i < trail.length; i++) {
                var t = trail[i];
                var a = (i / trail.length) * 0.15;
                drawLobster(t.x, t.y, lobster.w, lobster.h, t.r, a);
            }
        }

        function drawMenu() {
            ctx.fillStyle = 'rgba(12, 18, 34, 0.5)';
            ctx.fillRect(0, 0, W, H);

            // Draw the lobster big in the center
            drawLobster(W/2 - 46, H/2 - 130, 92, 72, 0, 1);

            ctx.textAlign = 'center';

            // "AGENTIC" label under the lobster
            ctx.font = '800 9px Inter, sans-serif';
            ctx.fillStyle = '#4ade80';
            ctx.fillText('A G E N T I C', W/2, H/2 - 75);

            ctx.fillStyle = 'white';
            ctx.font = '800 26px Inter, sans-serif';
            ctx.fillText('Flappy Lobster', W/2, H/2 - 48);

            ctx.fillStyle = '#94a3b8';
            ctx.font = '500 13px Inter, sans-serif';
            ctx.fillText('Navigate the slaw pipeline', W/2, H/2 - 22);

            // Hazards
            ctx.font = '500 11px Inter, sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('AVOID:', W/2, H/2 + 12);
            ctx.fillText('ü•õ Mayo   üçá Raisins   üçç Pineapple   ü§ç Marshmallows', W/2, H/2 + 29);
            ctx.fillStyle = '#4ade80';
            ctx.fillText('COLLECT: ü•¨ Cabbage (+2 pts)', W/2, H/2 + 49);

            var bounce = Math.sin(globalFrame * 0.06) * 4;
            ctx.fillStyle = '#4ade80';
            ctx.font = '600 15px Inter, sans-serif';
            ctx.fillText('Tap or press Space to deploy', W/2, H/2 + 88 + bounce);

            if (highScore > 0) {
                ctx.fillStyle = '#475569';
                ctx.font = '600 12px Inter, sans-serif';
                ctx.fillText('Best: ' + highScore + ' slaws dodged', W/2, H/2 + 122);
            }
        }

        function drawDead() {
            ctx.fillStyle = 'rgba(12, 18, 34, 0.65)';
            ctx.fillRect(0, 0, W, H);

            var cw = 280, ch = 230;
            var cx = (W - cw) / 2, cy = (H - ch) / 2 - 20;
            ctx.fillStyle = '#1e293b';
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            roundRect(ctx, cx, cy, cw, ch, 16);
            ctx.fill();
            ctx.stroke();

            // Red warning stripe at top of card
            ctx.fillStyle = '#7f1d1d';
            roundRect(ctx, cx, cy, cw, 6, [16, 16, 0, 0]);
            ctx.fill();

            ctx.textAlign = 'center';
            ctx.fillStyle = '#ef4444';
            ctx.font = '800 22px Inter, sans-serif';
            ctx.fillText(lastDeathMsg || "Slaw'd!", W/2, cy + 38);

            ctx.fillStyle = '#64748b';
            ctx.font = '500 11px Inter, sans-serif';
            ctx.fillText('Agent terminated by slaw pipeline', W/2, cy + 58);

            ctx.fillStyle = '#94a3b8';
            ctx.font = '700 10px Inter, sans-serif';
            ctx.fillText('SLAWS DODGED', W/2, cy + 88);
            ctx.fillStyle = 'white';
            ctx.font = '800 40px Inter, sans-serif';
            ctx.fillText(score, W/2, cy + 132);

            ctx.font = '600 13px Inter, sans-serif';
            if (score >= highScore && score > 0) {
                ctx.fillStyle = '#4ade80';
                ctx.fillText('New personal best!', W/2, cy + 172);
            } else {
                ctx.fillStyle = '#475569';
                ctx.fillText('Best: ' + highScore, W/2, cy + 172);
            }

            // Deploy again prompt
            if (frameCount > 30) {
                var bounce = Math.sin(globalFrame * 0.06) * 3;
                ctx.fillStyle = '#94a3b8';
                ctx.font = '500 13px Inter, sans-serif';
                ctx.fillText('Tap to redeploy agent', W/2, cy + ch + 30 + bounce);
            }
        }

        function roundRect(context, x, y, w, h, r) {
            if (typeof r === 'number') r = [r, r, r, r];
            context.beginPath();
            context.moveTo(x + r[0], y);
            context.lineTo(x + w - r[1], y);
            context.quadraticCurveTo(x + w, y, x + w, y + r[1]);
            context.lineTo(x + w, y + h - r[2]);
            context.quadraticCurveTo(x + w, y + h, x + w - r[2], y + h);
            context.lineTo(x + r[3], y + h);
            context.quadraticCurveTo(x, y + h, x, y + h - r[3]);
            context.lineTo(x, y + r[0]);
            context.quadraticCurveTo(x, y, x + r[0], y);
            context.closePath();
        }

        // ‚îÄ‚îÄ Collision ‚îÄ‚îÄ
        function checkCollision() {
            if (lobster.y + lobster.h > H - GROUND_H) return { hit: true, msg: 'Cutting board!' };
            if (lobster.y < -4) return { hit: true, msg: "Slaw'd!" };
            var lx = lobster.x + 6, ly = lobster.y + 4;
            var lw = lobster.w - 12, lh = lobster.h - 8;
            for (var i = 0; i < pipes.length; i++) {
                var p = pipes[i];
                var px = p.x - 5, pw = PIPE_W + 10;
                if (lx + lw > px && lx < px + pw) {
                    if (ly < p.topH) return { hit: true, msg: p.type.deathMsg };
                    if (ly + lh > p.topH + PIPE_GAP) return { hit: true, msg: p.type.deathMsg };
                }
            }
            return { hit: false };
        }

        function checkCabbageCollect() {
            var lx = lobster.x + 4, ly = lobster.y + 4;
            var lw = lobster.w - 8, lh = lobster.h - 8;
            for (var i = 0; i < cabbages.length; i++) {
                var c = cabbages[i];
                if (c.collected) continue;
                if (lx + lw > c.x && lx < c.x + CABBAGE_SIZE &&
                    ly + lh > c.y && ly < c.y + CABBAGE_SIZE) {
                    c.collected = true;
                    score += 2;
                    addToast('+2 CRUNCH!', c.x + CABBAGE_SIZE/2, c.y, '#4ade80');
                    for (var j = 0; j < 6; j++) {
                        particles.push({
                            x: c.x + CABBAGE_SIZE/2, y: c.y + CABBAGE_SIZE/2,
                            vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5,
                            life: 20, maxLife: 20, isJet: true, isSpark: true,
                            emoji: '', size: 0
                        });
                    }
                }
            }
        }

        // ‚îÄ‚îÄ Update ‚îÄ‚îÄ
        function update() {
            frameCount++;
            globalFrame++;

            if (state === STATE_PLAYING) {
                // Trail
                if (globalFrame % 2 === 0) {
                    trail.push({ x: lobster.x, y: lobster.y, r: lobster.rotation });
                    if (trail.length > TRAIL_LEN) trail.shift();
                }

                lobster.vy += GRAVITY;
                if (lobster.vy > MAX_FALL) lobster.vy = MAX_FALL;
                lobster.y += lobster.vy;

                var targetRot = lobster.vy * 0.06;
                targetRot = Math.max(-0.5, Math.min(1.2, targetRot));
                lobster.rotation += (targetRot - lobster.rotation) * 0.15;

                // Ambient engine particles (subtle)
                if (globalFrame % 4 === 0) {
                    particles.push({
                        x: lobster.x + lobster.w * 0.25,
                        y: lobster.y + lobster.h * 0.5 + (Math.random()-0.5)*6,
                        vx: -0.5 - Math.random() * 0.5,
                        vy: (Math.random()-0.5) * 0.5,
                        life: 8 + Math.random() * 6,
                        maxLife: 14,
                        isJet: true,
                        emoji: '', size: 0
                    });
                }

                pipeTimer++;
                if (pipeTimer >= PIPE_SPAWN) { pipeTimer = 0; spawnPipe(); }

                for (var i = pipes.length - 1; i >= 0; i--) {
                    pipes[i].x -= pipeSpeed;
                    if (!pipes[i].scored && pipes[i].x + PIPE_W < lobster.x) {
                        pipes[i].scored = true;
                        score++;
                        addToast(pipes[i].type.emoji + ' dodged!', lobster.x + 50, lobster.y - 10, '#94a3b8');
                        if (score % 5 === 0 && pipeSpeed < 4.5) pipeSpeed += 0.15;
                    }
                    if (pipes[i].x < -PIPE_W - 20) pipes.splice(i, 1);
                }

                for (var i = cabbages.length - 1; i >= 0; i--) {
                    cabbages[i].x -= pipeSpeed;
                    if (cabbages[i].x < -CABBAGE_SIZE - 10) cabbages.splice(i, 1);
                }
                checkCabbageCollect();

                for (var i = 0; i < milestones.length; i++) {
                    var m = milestones[i];
                    if (score >= m.at && !milestonesHit[m.at]) {
                        milestonesHit[m.at] = true;
                        addToast(m.msg, W/2, H/2 - 50, '#fbbf24');
                    }
                }

                groundX -= pipeSpeed;

                var result = checkCollision();
                if (result.hit) {
                    state = STATE_DEAD;
                    frameCount = 0;
                    lastDeathMsg = result.msg;
                    if (score > highScore) {
                        highScore = score;
                        localStorage.setItem('flappy-lobster-high', highScore.toString());
                    }
                    createDeathParticles();
                    pipeSpeed = 2.5;
                    trail = [];
                }
            } else if (state === STATE_MENU) {
                lobster.y = H/2 + Math.sin(globalFrame * 0.04) * 15;
                lobster.rotation = Math.sin(globalFrame * 0.06) * 0.08;
                groundX -= 1;
            } else {
                if (lobster.y + lobster.h < H - GROUND_H) {
                    lobster.vy += GRAVITY;
                    lobster.y += lobster.vy;
                    lobster.rotation += 0.12;
                }
            }
        }

        // ‚îÄ‚îÄ Draw ‚îÄ‚îÄ
        function draw() {
            drawBackground();
            for (var i = 0; i < pipes.length; i++) drawPipe(pipes[i]);
            drawCabbages();
            drawGround();

            if (state === STATE_PLAYING) {
                drawTrail();
            }

            if (state !== STATE_DEAD || frameCount < 60) {
                drawLobster(lobster.x, lobster.y, lobster.w, lobster.h, lobster.rotation, 1);
            }

            drawParticles();
            drawToasts();

            if (state === STATE_PLAYING) drawScore();
            else if (state === STATE_MENU) drawMenu();
            else if (state === STATE_DEAD) drawDead();
        }

        function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
        gameLoop();
    })();
    </script>
</body>
</html>
