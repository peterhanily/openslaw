<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Slaw ‚Äî OpenSlaw.ai</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .game-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .game-header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .game-header h1 span {
            color: #4ade80;
        }

        .game-header p {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .score-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 400px;
            margin-bottom: 0.5rem;
            padding: 0 0.25rem;
        }

        .score-bar .score-item {
            font-size: 0.8rem;
            font-weight: 600;
            color: #94a3b8;
        }

        .score-bar .score-item strong {
            color: #e2e8f0;
            font-weight: 800;
        }

        .score-bar .level-item {
            font-size: 0.75rem;
            font-weight: 700;
            color: #4ade80;
        }

        .game-container {
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(22, 163, 74, 0.15), 0 0 0 1px rgba(255,255,255,0.05);
        }

        canvas { display: block; }

        .game-footer {
            text-align: center;
            margin-top: 1rem;
        }

        .game-footer a {
            color: #4ade80;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .game-footer a:hover { text-decoration: underline; }

        .controls-hint {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            pointer-events: none;
        }

        .toast {
            background: #1e293b;
            border: 1px solid #4ade80;
            color: #4ade80;
            padding: 0.5rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 700;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
            opacity: 0;
            transform: translateY(-10px);
            animation: toastIn 0.3s ease forwards, toastOut 0.3s ease 2s forwards;
        }

        @keyframes toastIn {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes toastOut {
            to { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1>ü¶û Snake <span>Slaw</span></h1>
        <p>Grow the ultimate coleslaw. Avoid the mayo.</p>
    </div>
    <div class="score-bar" id="scoreBar">
        <div class="score-item">Score: <strong id="scoreDisplay">0</strong></div>
        <div class="level-item" id="levelDisplay">Level 1</div>
        <div class="score-item">Best: <strong id="highScoreDisplay">0</strong></div>
    </div>
    <div class="game-container">
        <canvas id="game" width="400" height="400"></canvas>
    </div>
    <div class="game-footer">
        <a href="/">‚Üê Back to OpenSlaw.ai</a>
        <div class="controls-hint">Arrow keys to move ¬∑ Swipe on mobile</div>
    </div>
    <div class="toast-container" id="toastContainer"></div>

    <script>
    (function() {
        var canvas = document.getElementById('game');
        var ctx = canvas.getContext('2d');
        var W = canvas.width;
        var H = canvas.height;

        var GRID = 20;
        var COLS = W / GRID;
        var ROWS = H / GRID;

        var STATE_MENU = 0, STATE_PLAYING = 1, STATE_DEAD = 2;
        var state = STATE_MENU;

        var score = 0;
        var level = 1;
        var highScore = parseInt(localStorage.getItem('snake-slaw-high') || '0');
        var globalFrame = 0;
        var deathFrameCount = 0;
        var deathMessage = '';

        // Score/level display elements
        var scoreDisplay = document.getElementById('scoreDisplay');
        var highScoreDisplay = document.getElementById('highScoreDisplay');
        var levelDisplay = document.getElementById('levelDisplay');
        var toastContainer = document.getElementById('toastContainer');

        highScoreDisplay.textContent = highScore;

        // Snake
        var snake = [];
        var dir = { x: 1, y: 0 };
        var nextDir = { x: 1, y: 0 };

        // Cabbage (food)
        var cabbage = { x: 10, y: 10 };

        // Mayo obstacles
        var mayos = [];
        var mayoTimer = 0;
        var MAYO_INTERVAL = 15000; // ms
        var MAX_MAYOS = 5;

        // Game timing
        var baseInterval = 150;
        var gameInterval = baseInterval;
        var lastTick = 0;
        var lastMayoTime = 0;

        // Level milestones
        var levelMilestones = {
            10: 'Level 2: Shredding phase!',
            20: 'Level 3: Dressing mixed!',
            30: 'Level 4: Tossing commenced!',
            40: 'Level 5: Approaching AGC...'
        };
        var milestonesHit = {};

        // Touch swipe
        var touchStartX = 0;
        var touchStartY = 0;

        function showToast(msg) {
            var el = document.createElement('div');
            el.className = 'toast';
            el.textContent = msg;
            toastContainer.appendChild(el);
            setTimeout(function() {
                if (el.parentNode) el.parentNode.removeChild(el);
            }, 2500);
        }

        function reset() {
            snake = [
                { x: 5, y: Math.floor(ROWS / 2) },
                { x: 4, y: Math.floor(ROWS / 2) },
                { x: 3, y: Math.floor(ROWS / 2) }
            ];
            dir = { x: 1, y: 0 };
            nextDir = { x: 1, y: 0 };
            score = 0;
            level = 1;
            mayos = [];
            milestonesHit = {};
            gameInterval = baseInterval;
            lastMayoTime = performance.now();
            deathMessage = '';
            deathFrameCount = 0;
            placeCabbage();
            updateDisplays();
        }

        function updateDisplays() {
            scoreDisplay.textContent = score;
            highScoreDisplay.textContent = highScore;
            levelDisplay.textContent = 'Level ' + level;
        }

        function isOccupied(x, y) {
            for (var i = 0; i < snake.length; i++) {
                if (snake[i].x === x && snake[i].y === y) return true;
            }
            for (var i = 0; i < mayos.length; i++) {
                if (mayos[i].x === x && mayos[i].y === y) return true;
            }
            return false;
        }

        function placeCabbage() {
            var attempts = 0;
            do {
                cabbage.x = Math.floor(Math.random() * COLS);
                cabbage.y = Math.floor(Math.random() * ROWS);
                attempts++;
            } while (isOccupied(cabbage.x, cabbage.y) && attempts < 500);
        }

        function placeMayo() {
            if (mayos.length >= MAX_MAYOS) return;
            var attempts = 0;
            var mx, my;
            do {
                mx = Math.floor(Math.random() * COLS);
                my = Math.floor(Math.random() * ROWS);
                attempts++;
            } while ((isOccupied(mx, my) || (mx === cabbage.x && my === cabbage.y)) && attempts < 500);
            if (attempts < 500) {
                mayos.push({ x: mx, y: my, spawnFrame: globalFrame });
            }
        }

        function checkLevelUp() {
            var newLevel = Math.floor(score / 10) + 1;
            if (newLevel > level) {
                level = newLevel;
                gameInterval = Math.max(80, baseInterval - (level - 1) * 10);
                var milestone = levelMilestones[score];
                if (milestone && !milestonesHit[score]) {
                    milestonesHit[score] = true;
                    showToast(milestone);
                }
                updateDisplays();
            }
        }

        function tick() {
            // Apply buffered direction
            dir.x = nextDir.x;
            dir.y = nextDir.y;

            var head = snake[0];
            var newHead = { x: head.x + dir.x, y: head.y + dir.y };

            // Wall collision
            if (newHead.x < 0 || newHead.x >= COLS || newHead.y < 0 || newHead.y >= ROWS) {
                die('Walled!');
                return;
            }

            // Self collision
            for (var i = 0; i < snake.length; i++) {
                if (snake[i].x === newHead.x && snake[i].y === newHead.y) {
                    die('Self-slawed!');
                    return;
                }
            }

            // Mayo collision
            for (var i = 0; i < mayos.length; i++) {
                if (mayos[i].x === newHead.x && mayos[i].y === newHead.y) {
                    die("Mayo'd!");
                    return;
                }
            }

            snake.unshift(newHead);

            // Cabbage collection
            if (newHead.x === cabbage.x && newHead.y === cabbage.y) {
                score++;
                checkLevelUp();
                updateDisplays();
                placeCabbage();
                // Don't remove tail ‚Äî snake grows
            } else {
                snake.pop();
            }
        }

        function die(msg) {
            state = STATE_DEAD;
            deathMessage = msg;
            deathFrameCount = 0;
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('snake-slaw-high', highScore.toString());
            }
            updateDisplays();
        }

        // ‚îÄ‚îÄ Input ‚îÄ‚îÄ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                e.preventDefault();
            }

            if (state === STATE_MENU) {
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    state = STATE_PLAYING;
                    reset();
                    if (e.key === 'ArrowUp') { nextDir = { x: 0, y: -1 }; }
                    else if (e.key === 'ArrowDown') { nextDir = { x: 0, y: 1 }; }
                    else if (e.key === 'ArrowLeft') { nextDir = { x: -1, y: 0 }; }
                    else if (e.key === 'ArrowRight') { nextDir = { x: 1, y: 0 }; }
                    dir.x = nextDir.x;
                    dir.y = nextDir.y;
                }
                return;
            }

            if (state === STATE_PLAYING) {
                if (e.key === 'ArrowUp' && dir.y !== 1) { nextDir = { x: 0, y: -1 }; }
                else if (e.key === 'ArrowDown' && dir.y !== -1) { nextDir = { x: 0, y: 1 }; }
                else if (e.key === 'ArrowLeft' && dir.x !== 1) { nextDir = { x: -1, y: 0 }; }
                else if (e.key === 'ArrowRight' && dir.x !== -1) { nextDir = { x: 1, y: 0 }; }
            }
        });

        // Touch swipe
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            if (state === STATE_DEAD && deathFrameCount > 30) {
                state = STATE_MENU;
                return;
            }
            var touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
        });

        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
        });

        canvas.addEventListener('touchend', function(e) {
            e.preventDefault();
            if (state === STATE_DEAD) return;

            var touch = e.changedTouches[0];
            var dx = touch.clientX - touchStartX;
            var dy = touch.clientY - touchStartY;
            var absDx = Math.abs(dx);
            var absDy = Math.abs(dy);

            if (absDx < 10 && absDy < 10) {
                // Tap ‚Äî start game if on menu
                if (state === STATE_MENU) {
                    state = STATE_PLAYING;
                    reset();
                }
                return;
            }

            var newDir;
            if (absDx > absDy) {
                newDir = dx > 0 ? { x: 1, y: 0 } : { x: -1, y: 0 };
            } else {
                newDir = dy > 0 ? { x: 0, y: 1 } : { x: 0, y: -1 };
            }

            if (state === STATE_MENU) {
                state = STATE_PLAYING;
                reset();
                nextDir = newDir;
                dir.x = nextDir.x;
                dir.y = nextDir.y;
            } else if (state === STATE_PLAYING) {
                // Prevent 180-degree turns
                if (newDir.x !== -dir.x || newDir.y !== -dir.y) {
                    nextDir = newDir;
                }
            }
        });

        canvas.addEventListener('click', function() {
            if (state === STATE_DEAD && deathFrameCount > 30) {
                state = STATE_MENU;
            }
        });

        // ‚îÄ‚îÄ Drawing ‚îÄ‚îÄ

        function drawGrid() {
            // Dark background
            ctx.fillStyle = '#1e293b';
            ctx.fillRect(0, 0, W, H);

            // Subtle grid lines
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 0.5;
            for (var x = 0; x <= W; x += GRID) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, H);
                ctx.stroke();
            }
            for (var y = 0; y <= H; y += GRID) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(W, y);
                ctx.stroke();
            }
        }

        function drawSnake() {
            var len = snake.length;
            for (var i = len - 1; i >= 0; i--) {
                var seg = snake[i];
                var px = seg.x * GRID;
                var py = seg.y * GRID;

                if (i === 0) {
                    // Head ‚Äî lobster emoji
                    ctx.font = (GRID - 2) + 'px serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('\uD83E\uDD9E', px + GRID / 2, py + GRID / 2 + 1);
                } else {
                    // Body segment ‚Äî gradient greens, lighter toward tail
                    var t = i / len;
                    var r = Math.floor(34 + t * 40);
                    var g = Math.floor(197 - t * 60);
                    var b = Math.floor(94 + t * 40);
                    var baseColor = 'rgb(' + r + ',' + g + ',' + b + ')';

                    var lightR = Math.min(255, r + 30);
                    var lightG = Math.min(255, g + 30);
                    var lightB = Math.min(255, b + 30);
                    var lightColor = 'rgb(' + lightR + ',' + lightG + ',' + lightB + ')';

                    var grad = ctx.createLinearGradient(px, py, px + GRID, py + GRID);
                    grad.addColorStop(0, lightColor);
                    grad.addColorStop(1, baseColor);
                    ctx.fillStyle = grad;

                    var padding = 1;
                    var radius = 5;
                    roundRect(ctx, px + padding, py + padding, GRID - padding * 2, GRID - padding * 2, radius);
                    ctx.fill();

                    // Subtle inner highlight
                    ctx.fillStyle = 'rgba(255,255,255,0.08)';
                    roundRect(ctx, px + padding + 1, py + padding + 1, GRID - padding * 2 - 4, (GRID - padding * 2) / 2 - 1, [radius - 1, radius - 1, 2, 2]);
                    ctx.fill();
                }
            }
        }

        function drawCabbage() {
            var px = cabbage.x * GRID;
            var py = cabbage.y * GRID;

            // Glow effect
            var pulse = Math.sin(globalFrame * 0.08) * 0.15 + 0.85;
            var glowRadius = GRID * 1.2 * pulse;
            var grd = ctx.createRadialGradient(
                px + GRID / 2, py + GRID / 2, 2,
                px + GRID / 2, py + GRID / 2, glowRadius
            );
            grd.addColorStop(0, 'rgba(74, 222, 128, 0.35)');
            grd.addColorStop(1, 'rgba(74, 222, 128, 0)');
            ctx.fillStyle = grd;
            ctx.beginPath();
            ctx.arc(px + GRID / 2, py + GRID / 2, glowRadius, 0, Math.PI * 2);
            ctx.fill();

            // Cabbage emoji
            ctx.font = (GRID - 2) + 'px serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            var bob = Math.sin(globalFrame * 0.06) * 2;
            ctx.fillText('\uD83E\uDD6C', px + GRID / 2, py + GRID / 2 + bob + 1);
        }

        function drawMayos() {
            for (var i = 0; i < mayos.length; i++) {
                var m = mayos[i];
                var px = m.x * GRID;
                var py = m.y * GRID;

                // Danger glow
                var pulse = Math.sin(globalFrame * 0.1 + i) * 0.2 + 0.8;
                ctx.fillStyle = 'rgba(253, 224, 71, ' + (0.1 * pulse) + ')';
                ctx.beginPath();
                ctx.arc(px + GRID / 2, py + GRID / 2, GRID * 0.8, 0, Math.PI * 2);
                ctx.fill();

                // Mayo emoji
                ctx.font = (GRID - 4) + 'px serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('\uD83E\uDD5B', px + GRID / 2, py + GRID / 2 + 1);
            }
        }

        function drawMenu() {
            ctx.fillStyle = 'rgba(15, 23, 42, 0.7)';
            ctx.fillRect(0, 0, W, H);

            ctx.textAlign = 'center';

            // Lobster emoji big
            ctx.font = '48px serif';
            ctx.fillText('\uD83E\uDD9E', W / 2, H / 2 - 90);

            // Title
            ctx.fillStyle = '#e2e8f0';
            ctx.font = '800 28px Inter, sans-serif';
            ctx.fillText('Snake Slaw', W / 2, H / 2 - 40);

            // Tagline
            ctx.fillStyle = '#94a3b8';
            ctx.font = '500 13px Inter, sans-serif';
            ctx.fillText('Grow the ultimate coleslaw recipe', W / 2, H / 2 - 16);

            // Instructions
            ctx.fillStyle = '#64748b';
            ctx.font = '500 11px Inter, sans-serif';
            ctx.fillText('COLLECT: \uD83E\uDD6C Cabbage (+1 pt, +1 segment)', W / 2, H / 2 + 18);
            ctx.fillText('AVOID: \uD83E\uDD5B Mayo blobs, walls, yourself', W / 2, H / 2 + 38);

            // Start prompt
            var bounce = Math.sin(globalFrame * 0.06) * 4;
            ctx.fillStyle = '#4ade80';
            ctx.font = '600 15px Inter, sans-serif';
            ctx.fillText('Press any arrow key to start', W / 2, H / 2 + 78 + bounce);

            if (highScore > 0) {
                ctx.fillStyle = '#475569';
                ctx.font = '600 12px Inter, sans-serif';
                ctx.fillText('Best: ' + highScore, W / 2, H / 2 + 110);
            }
        }

        function drawDead() {
            ctx.fillStyle = 'rgba(15, 23, 42, 0.75)';
            ctx.fillRect(0, 0, W, H);

            var cw = 260, ch = 220;
            var cx = (W - cw) / 2, cy = (H - ch) / 2 - 10;

            // Card background
            ctx.fillStyle = '#1e293b';
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            roundRect(ctx, cx, cy, cw, ch, 16);
            ctx.fill();
            ctx.stroke();

            // Red stripe at top
            ctx.fillStyle = '#7f1d1d';
            roundRect(ctx, cx, cy, cw, 6, [16, 16, 0, 0]);
            ctx.fill();

            ctx.textAlign = 'center';

            // Death message
            ctx.fillStyle = '#ef4444';
            ctx.font = '800 22px Inter, sans-serif';
            ctx.fillText(deathMessage, W / 2, cy + 42);

            // Sub text
            ctx.fillStyle = '#64748b';
            ctx.font = '500 11px Inter, sans-serif';
            ctx.fillText('Recipe terminated', W / 2, cy + 62);

            // Score label
            ctx.fillStyle = '#94a3b8';
            ctx.font = '700 10px Inter, sans-serif';
            ctx.fillText('CABBAGES COLLECTED', W / 2, cy + 90);

            // Score value
            ctx.fillStyle = '#e2e8f0';
            ctx.font = '800 40px Inter, sans-serif';
            ctx.fillText(score, W / 2, cy + 134);

            // High score or new best
            ctx.font = '600 13px Inter, sans-serif';
            if (score >= highScore && score > 0) {
                ctx.fillStyle = '#4ade80';
                ctx.fillText('New personal best!', W / 2, cy + 168);
            } else {
                ctx.fillStyle = '#475569';
                ctx.fillText('Best: ' + highScore, W / 2, cy + 168);
            }

            // Level reached
            ctx.fillStyle = '#64748b';
            ctx.font = '500 11px Inter, sans-serif';
            ctx.fillText('Level ' + level + ' reached', W / 2, cy + 192);

            // Retry prompt
            if (deathFrameCount > 30) {
                var bounce = Math.sin(globalFrame * 0.06) * 3;
                ctx.fillStyle = '#94a3b8';
                ctx.font = '500 13px Inter, sans-serif';
                ctx.fillText('Tap to retry', W / 2, cy + ch + 25 + bounce);
            }
        }

        function roundRect(context, x, y, w, h, r) {
            if (typeof r === 'number') r = [r, r, r, r];
            context.beginPath();
            context.moveTo(x + r[0], y);
            context.lineTo(x + w - r[1], y);
            context.quadraticCurveTo(x + w, y, x + w, y + r[1]);
            context.lineTo(x + w, y + h - r[2]);
            context.quadraticCurveTo(x + w, y + h, x + w - r[2], y + h);
            context.lineTo(x + r[3], y + h);
            context.quadraticCurveTo(x, y + h, x, y + h - r[3]);
            context.lineTo(x, y + r[0]);
            context.quadraticCurveTo(x, y, x + r[0], y);
            context.closePath();
        }

        // ‚îÄ‚îÄ Game loop ‚îÄ‚îÄ

        function gameLoop(timestamp) {
            globalFrame++;

            if (state === STATE_DEAD) {
                deathFrameCount++;
            }

            // Game tick (grid-based movement at interval)
            if (state === STATE_PLAYING) {
                if (!lastTick) lastTick = timestamp;
                if (timestamp - lastTick >= gameInterval) {
                    lastTick = timestamp;
                    tick();
                }

                // Mayo spawning
                if (timestamp - lastMayoTime >= MAYO_INTERVAL) {
                    lastMayoTime = timestamp;
                    placeMayo();
                }
            }

            // Draw
            drawGrid();

            if (state === STATE_PLAYING || state === STATE_DEAD) {
                drawMayos();
                drawCabbage();
                drawSnake();
            }

            if (state === STATE_MENU) {
                drawMenu();
            } else if (state === STATE_DEAD) {
                drawDead();
            }

            requestAnimationFrame(gameLoop);
        }

        // Initialize
        reset();
        state = STATE_MENU;
        requestAnimationFrame(gameLoop);
    })();
    </script>
</body>
</html>
